<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>KartaFlow — Your Polish Residency. Finally Under Control.</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;0,9..144,700;0,9..144,900;1,9..144,300;1,9..144,700&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
<style>
:root {
  --red: #E8132A;
  --red-deep: #B50F20;
  --red-soft: rgba(232,19,42,0.08);
  --red-border: rgba(232,19,42,0.2);
  --white: #FFFFFF;
  --off-white: #F8F6F3;
  --surface: #F2F0ED;
  --surface-2: #ECEAE7;
  --border: rgba(0,0,0,0.08);
  --border-strong: rgba(0,0,0,0.14);
  --dark: #0D0D0D;
  --dark-2: #1A1A1A;
  --text: #111111;
  --text-2: #444444;
  --text-3: #888888;
  --text-4: #BBBBBB;
  --success: #16A34A;
  --warning: #D97706;
  --font-display: 'Fraunces', serif;
  --font-body: 'DM Sans', sans-serif;
  --r: 14px;
  --r-lg: 22px;
  --r-xl: 32px;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
  --shadow: 0 4px 16px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.06);
  --shadow-lg: 0 16px 48px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.08);
  --shadow-red: 0 8px 32px rgba(232,19,42,0.2);
  --ease: cubic-bezier(0.4, 0, 0.2, 1);
  --ease-out: cubic-bezier(0, 0, 0.2, 1);
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
html { scroll-behavior: smooth; font-size: 16px; -webkit-font-smoothing: antialiased; }
body {
  font-family: var(--font-body);
  background: var(--white);
  color: var(--text);
  overflow-x: hidden;
  min-height: 100vh;
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--surface-2); border-radius: 3px; }

/* PAGE SYSTEM */
.page { display: none; min-height: 100vh; position: relative; }
.page.active { display: block; }

/* ANIMATED BG CANVAS */
#bg-canvas {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  z-index: 0; pointer-events: none;
}

/* ═══ NAVIGATION ═══ */
.nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 200;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; height: 64px;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(24px) saturate(180%);
  -webkit-backdrop-filter: blur(24px) saturate(180%);
  border-bottom: 1px solid var(--border);
  transition: all 0.3s var(--ease);
}
.nav-logo {
  font-family: var(--font-display);
  font-size: 20px; font-weight: 700;
  color: var(--dark); text-decoration: none;
  cursor: pointer; display: flex; align-items: center; gap: 2px;
  letter-spacing: -0.02em;
}
.nav-logo .accent { color: var(--red); }
.nav-center { display: flex; align-items: center; gap: 6px; }
.nav-link {
  padding: 7px 14px; border-radius: 100px;
  font-size: 14px; font-weight: 500; color: var(--text-2);
  cursor: pointer; transition: all 0.2s var(--ease);
  text-decoration: none; white-space: nowrap;
  background: transparent; border: none; font-family: var(--font-body);
}
.nav-link:hover { background: var(--surface); color: var(--text); }
.nav-actions { display: flex; align-items: center; gap: 8px; }
.nav-menu-btn {
  display: none; width: 40px; height: 40px; border: none;
  background: var(--surface); border-radius: 10px;
  cursor: pointer; align-items: center; justify-content: center;
  color: var(--text);
}

/* ═══ MOBILE MENU ═══ */
.mobile-menu {
  display: none; position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
}
.mobile-menu.open { display: flex; align-items: flex-end; }
.mobile-menu-sheet {
  background: var(--white); border-radius: 28px 28px 0 0;
  width: 100%; padding: 24px 20px 40px;
  animation: sheet-up 0.3s var(--ease-out);
}
@keyframes sheet-up { from { transform: translateY(100%); } to { transform: none; } }
.mobile-menu-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 24px; padding-bottom: 20px;
  border-bottom: 1px solid var(--border);
}
.mobile-nav-links { display: flex; flex-direction: column; gap: 4px; margin-bottom: 20px; }
.mobile-nav-link {
  padding: 14px 16px; border-radius: var(--r); font-size: 16px;
  font-weight: 500; color: var(--text); cursor: pointer;
  transition: background 0.2s; border: none; background: transparent;
  text-align: left; font-family: var(--font-body); width: 100%;
  display: flex; align-items: center; gap: 12px;
}
.mobile-nav-link:hover, .mobile-nav-link:active { background: var(--surface); }

/* ═══ BUTTONS ═══ */
.btn {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 11px 22px; border-radius: 100px;
  font-family: var(--font-body); font-size: 14px; font-weight: 600;
  cursor: pointer; border: none; transition: all 0.2s var(--ease);
  text-decoration: none; white-space: nowrap; line-height: 1;
}
.btn svg { width: 16px; height: 16px; flex-shrink: 0; }
.btn-primary {
  background: var(--red); color: white;
  box-shadow: 0 1px 3px rgba(232,19,42,0.3), 0 4px 12px rgba(232,19,42,0.15);
}
.btn-primary:hover { background: var(--red-deep); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(232,19,42,0.3); }
.btn-primary:active { transform: translateY(0); }
.btn-dark { background: var(--dark); color: white; box-shadow: var(--shadow-sm); }
.btn-dark:hover { background: #222; transform: translateY(-1px); box-shadow: var(--shadow); }
.btn-outline { background: transparent; color: var(--text); border: 1.5px solid var(--border-strong); }
.btn-outline:hover { border-color: var(--text); background: var(--off-white); }
.btn-ghost { background: transparent; color: var(--text-2); border: none; }
.btn-ghost:hover { color: var(--text); background: var(--surface); }
.btn-sm { padding: 8px 16px; font-size: 13px; }
.btn-lg { padding: 15px 32px; font-size: 15px; }
.btn-full { width: 100%; justify-content: center; }
.btn-surface { background: var(--surface); color: var(--text); }
.btn-surface:hover { background: var(--surface-2); }

/* ═══ TYPOGRAPHY ═══ */
.display-xl {
  font-family: var(--font-display);
  font-size: clamp(42px, 6.5vw, 88px);
  font-weight: 700; line-height: 1.0; letter-spacing: -0.03em;
}
.display-lg {
  font-family: var(--font-display);
  font-size: clamp(32px, 4.5vw, 60px);
  font-weight: 700; line-height: 1.05; letter-spacing: -0.025em;
}
.display-md {
  font-family: var(--font-display);
  font-size: clamp(24px, 3vw, 36px);
  font-weight: 700; line-height: 1.15; letter-spacing: -0.02em;
}
em { font-style: italic; color: var(--red); }
.label-xs {
  font-size: 11px; font-weight: 600; letter-spacing: 0.12em;
  text-transform: uppercase; color: var(--text-3);
}
.label-red {
  font-size: 12px; font-weight: 600; letter-spacing: 0.08em;
  text-transform: uppercase; color: var(--red);
  display: inline-flex; align-items: center; gap: 6px;
}

/* ═══ CARDS ═══ */
.card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  padding: 28px;
  transition: all 0.2s var(--ease);
  box-shadow: var(--shadow-sm);
}
.card:hover { box-shadow: var(--shadow); border-color: var(--border-strong); }
.card-surface {
  background: var(--surface);
  border-radius: var(--r-lg);
  padding: 28px;
}
.card-dark {
  background: var(--dark);
  border-radius: var(--r-lg);
  padding: 28px;
  color: white;
}

/* ═══ BADGE ═══ */
.badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 100px;
  font-size: 11px; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase;
}
.badge-red { background: var(--red-soft); color: var(--red); border: 1px solid var(--red-border); }
.badge-green { background: rgba(22,163,74,0.1); color: var(--success); border: 1px solid rgba(22,163,74,0.2); }
.badge-amber { background: rgba(217,119,6,0.1); color: var(--warning); border: 1px solid rgba(217,119,6,0.2); }
.badge-grey { background: var(--surface); color: var(--text-3); border: 1px solid var(--border); }
.badge-dark { background: var(--dark); color: white; }

/* ═══ TOAST ═══ */
#toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
.toast {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 20px; border-radius: 14px;
  background: var(--dark); color: white;
  min-width: 260px; max-width: 360px;
  box-shadow: var(--shadow-lg); font-size: 14px; font-weight: 500;
  animation: toast-in 0.3s var(--ease-out); pointer-events: all;
}
.toast.success { background: #16A34A; }
.toast.error { background: #DC2626; }
@keyframes toast-in { from { opacity:0; transform: translateY(8px) scale(0.97); } to { opacity:1; transform: none; } }

/* ═══ MODAL ═══ */
.modal-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(0,0,0,0.4); backdrop-filter: blur(8px);
  display: none; align-items: center; justify-content: center; padding: 20px;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--white); border-radius: var(--r-xl);
  padding: 40px; max-width: 520px; width: 100%;
  box-shadow: var(--shadow-lg); position: relative;
  animation: modal-in 0.3s var(--ease-out);
}
@keyframes modal-in { from { opacity:0; transform: scale(0.97) translateY(10px); } to { opacity:1; transform: none; } }
.modal-close {
  position: absolute; top: 16px; right: 16px;
  width: 36px; height: 36px; border-radius: 100px;
  background: var(--surface); border: none; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  color: var(--text-2); transition: all 0.2s;
}
.modal-close:hover { background: var(--surface-2); color: var(--text); }

/* ═══ FORMS ═══ */
.form-group { margin-bottom: 18px; }
.form-label { display: block; margin-bottom: 7px; font-size: 13px; font-weight: 600; color: var(--text-2); }
.form-input, .form-select {
  width: 100%; padding: 13px 15px;
  background: var(--off-white); border: 1.5px solid var(--border);
  border-radius: var(--r); color: var(--text);
  font-family: var(--font-body); font-size: 15px;
  transition: all 0.2s; outline: none;
}
.form-input:focus, .form-select:focus {
  border-color: var(--red); background: white;
  box-shadow: 0 0 0 3px var(--red-soft);
}
.form-input::placeholder { color: var(--text-4); }
.form-hint { font-size: 12px; color: var(--text-3); margin-top: 5px; }

/* ─────────────────────────────────────────
   LANDING PAGE
───────────────────────────────────────── */

/* HERO */
.hero {
  min-height: 100vh; padding: 80px 24px 60px;
  display: flex; align-items: center;
  position: relative; overflow: hidden;
}
.hero-inner {
  max-width: 1100px; margin: 0 auto; width: 100%;
  display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center;
  position: relative; z-index: 1;
}
.hero-eyebrow {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 6px 14px; border-radius: 100px;
  background: var(--red-soft); border: 1px solid var(--red-border);
  color: var(--red); font-size: 12px; font-weight: 600;
  letter-spacing: 0.06em; text-transform: uppercase;
  margin-bottom: 24px;
}
.hero-title { margin-bottom: 20px; }
.hero-sub {
  font-size: 17px; line-height: 1.65; color: var(--text-2);
  margin-bottom: 36px; max-width: 480px; font-weight: 400;
}
.hero-ctas { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 40px; }
.hero-trust {
  display: flex; align-items: center; gap: 20px;
  flex-wrap: wrap; padding-top: 28px;
  border-top: 1px solid var(--border);
}
.trust-item {
  display: flex; align-items: center; gap: 8px;
  font-size: 13px; color: var(--text-3); font-weight: 500;
}
.trust-item svg { width: 16px; height: 16px; color: var(--success); flex-shrink: 0; }

/* HERO APP PREVIEW */
.hero-app {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: 24px;
  box-shadow: 0 32px 80px rgba(0,0,0,0.12), 0 8px 24px rgba(0,0,0,0.06);
  overflow: hidden;
}
.app-topbar {
  background: var(--off-white); padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
}
.app-dots { display: flex; gap: 6px; }
.app-dot { width: 11px; height: 11px; border-radius: 50%; }
.app-dot.r { background: #FF5F56; }
.app-dot.y { background: #FFBD2E; }
.app-dot.g { background: #27C93F; }
.app-topbar-url {
  flex: 1; background: white; border-radius: 7px; padding: 5px 12px;
  font-size: 12px; color: var(--text-3); text-align: center;
  border: 1px solid var(--border);
}
.app-body { padding: 20px; }
.app-case-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.app-case-id { font-size: 12px; color: var(--text-3); font-family: monospace; }
.app-progress-label { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.app-progress-label span { font-size: 13px; font-weight: 600; }
.app-progress-label small { font-size: 12px; color: var(--text-3); }
.app-progress { height: 6px; background: var(--surface); border-radius: 3px; overflow: hidden; margin-bottom: 18px; }
.app-progress-fill { height: 100%; background: var(--red); border-radius: 3px; width: 72%; }
.app-step {
  display: flex; align-items: center; gap: 12px; padding: 12px 14px;
  border-radius: 12px; margin-bottom: 8px; border: 1px solid var(--border);
  background: var(--white);
}
.app-step-icon {
  width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
}
.app-step-icon.done { background: rgba(22,163,74,0.1); color: var(--success); }
.app-step-icon.active { background: var(--red-soft); color: var(--red); }
.app-step-icon.pending { background: var(--surface); color: var(--text-4); }
.app-step-title { font-size: 13px; font-weight: 600; }
.app-step-sub { font-size: 11px; color: var(--text-3); margin-top: 1px; }
.app-step-badge { margin-left: auto; flex-shrink: 0; }

/* PROOF BAR */
.proof-bar {
  border-top: 1px solid var(--border); border-bottom: 1px solid var(--border);
  padding: 16px 0; overflow: hidden; background: var(--surface);
}
.proof-track {
  display: flex; align-items: center; gap: 48px;
  animation: marquee 28s linear infinite; white-space: nowrap; width: max-content;
}
.proof-item {
  display: flex; align-items: center; gap: 8px;
  font-size: 13px; color: var(--text-3); font-weight: 500;
}
.proof-item svg { width: 15px; height: 15px; color: var(--red); flex-shrink: 0; }
.proof-item strong { color: var(--text); }
@keyframes marquee { from { transform: translateX(0); } to { transform: translateX(-50%); } }

/* SECTIONS */
.section { padding: 80px 24px; position: relative; z-index: 1; }
.section-sm { padding: 60px 24px; position: relative; z-index: 1; }
.section-dark { background: var(--dark); color: white; }
.section-dark .text-sub { color: rgba(255,255,255,0.55); }
.container { max-width: 1100px; margin: 0 auto; width: 100%; }
.section-eyebrow { margin-bottom: 16px; }
.section-title { margin-bottom: 16px; }
.section-sub { font-size: 17px; color: var(--text-2); line-height: 1.65; max-width: 560px; margin-bottom: 48px; }

/* HOW IT WORKS */
.steps-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px;
  border-radius: var(--r-lg); overflow: hidden;
}
.step-card {
  background: var(--surface); padding: 32px 24px;
  position: relative; transition: all 0.2s var(--ease);
}
.step-card:hover { background: var(--surface-2); transform: translateY(-3px); z-index: 2; box-shadow: var(--shadow); }
.step-num {
  font-family: var(--font-display); font-size: 56px; font-weight: 900;
  color: rgba(0,0,0,0.04); line-height: 1;
  position: absolute; top: 16px; right: 20px;
}
.step-icon-wrap {
  width: 48px; height: 48px; border-radius: 14px;
  background: var(--white); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 18px; box-shadow: var(--shadow-sm);
  color: var(--red);
}
.step-title { font-size: 16px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.01em; }
.step-desc { font-size: 13px; color: var(--text-2); line-height: 1.6; }

/* WHAT YOU GET */
.feature-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.feature-card {
  background: var(--surface); border-radius: var(--r-lg);
  padding: 28px; transition: all 0.2s var(--ease);
  border: 1px solid transparent;
}
.feature-card:hover { background: var(--white); border-color: var(--border); box-shadow: var(--shadow); }
.feature-icon {
  width: 44px; height: 44px; border-radius: 12px;
  background: var(--white); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 16px; box-shadow: var(--shadow-sm); color: var(--red);
}
.feature-title { font-size: 15px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.01em; }
.feature-desc { font-size: 13px; color: var(--text-2); line-height: 1.6; }

/* PRICING */
.pricing-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; max-width: 980px; }
.pricing-card {
  background: var(--white); border: 1.5px solid var(--border);
  border-radius: var(--r-xl); padding: 36px 32px;
  position: relative; transition: all 0.25s var(--ease);
  box-shadow: var(--shadow-sm);
}
.pricing-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
.pricing-card.featured {
  background: var(--dark); color: white;
  border-color: var(--dark); transform: scale(1.03);
  box-shadow: 0 24px 64px rgba(0,0,0,0.25);
}
.pricing-card.featured:hover { transform: scale(1.03) translateY(-4px); }
.popular-tag {
  position: absolute; top: -13px; left: 50%; transform: translateX(-50%);
  background: var(--red); color: white; padding: 5px 16px; border-radius: 100px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase;
  white-space: nowrap;
}
.tier-label { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 6px; }
.tier-label.light { color: rgba(255,255,255,0.5); }
.tier-label.dark { color: var(--text-3); }
.tier-name { font-family: var(--font-display); font-size: 22px; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.01em; }
.tier-name.light { color: white; }
.tier-tagline { font-size: 13px; margin-bottom: 24px; }
.tier-tagline.light { color: rgba(255,255,255,0.55); }
.tier-tagline.dark { color: var(--text-3); }
.tier-price {
  font-family: var(--font-display); font-size: 48px; font-weight: 900;
  line-height: 1; letter-spacing: -0.03em; margin-bottom: 4px;
}
.tier-price.light { color: white; }
.tier-currency { font-size: 20px; font-weight: 600; vertical-align: super; line-height: 1; }
.tier-period { font-size: 14px; font-weight: 400; opacity: 0.6; }
.tier-savings {
  font-size: 12px; font-weight: 600; color: var(--success); margin-bottom: 24px;
  display: flex; align-items: center; gap: 5px;
}
.tier-savings.light { color: #4ADE80; }
.tier-divider { height: 1px; background: var(--border); margin: 20px 0; }
.tier-divider.light { background: rgba(255,255,255,0.1); }
.tier-features { list-style: none; margin-bottom: 28px; }
.tier-feature {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 8px 0; font-size: 14px; line-height: 1.4;
  border-bottom: 1px solid var(--border);
}
.tier-feature.light { border-bottom-color: rgba(255,255,255,0.07); color: rgba(255,255,255,0.85); }
.tier-feature:last-child { border-bottom: none; }
.tier-feature:last-child.light { border-bottom: none; }
.tier-check { width: 18px; height: 18px; flex-shrink: 0; margin-top: 1px; }
.tier-check.red { color: var(--red); }
.tier-check.green { color: var(--success); }
.tier-check.muted { color: var(--text-4); }
.tier-highlight {
  background: rgba(255,255,255,0.06); border-radius: var(--r);
  padding: 10px 14px; margin-bottom: 20px; font-size: 13px; color: rgba(255,255,255,0.7);
  display: flex; align-items: center; gap: 8px;
}
.tier-highlight svg { color: #FBBF24; flex-shrink: 0; }

/* TESTIMONIALS */
.testimonials-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.testimonial-card {
  background: var(--surface); border-radius: var(--r-lg);
  padding: 28px; transition: all 0.2s var(--ease);
}
.testimonial-card:hover { background: var(--white); box-shadow: var(--shadow); }
.stars { display: flex; gap: 3px; margin-bottom: 14px; color: #F59E0B; }
.stars svg { width: 14px; height: 14px; fill: currentColor; }
.testimonial-text {
  font-size: 15px; line-height: 1.7; color: var(--text-2);
  margin-bottom: 20px; font-style: italic;
}
.testimonial-author { display: flex; align-items: center; gap: 10px; }
.avatar {
  width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 700; background: var(--surface-2); color: var(--text);
}
.avatar-red { background: var(--red-soft); color: var(--red); }
.avatar-dark { background: var(--dark); color: white; }
.author-name { font-size: 14px; font-weight: 700; }
.author-meta { font-size: 12px; color: var(--text-3); margin-top: 1px; }

/* LAWYER SECTION */
.lawyer-section {
  background: var(--dark); color: white; border-radius: 28px;
  padding: 48px; display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center;
}
.lawyer-badge {
  width: 80px; height: 80px; border-radius: 50%;
  background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15);
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; font-weight: 700; font-family: var(--font-display);
  margin-bottom: 20px; color: white;
}
.lawyer-name { font-family: var(--font-display); font-size: 28px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.01em; }
.lawyer-title { font-size: 14px; color: rgba(255,255,255,0.55); margin-bottom: 20px; }
.lawyer-desc { font-size: 15px; color: rgba(255,255,255,0.7); line-height: 1.7; margin-bottom: 24px; }
.lawyer-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
.lawyer-stat-num { font-family: var(--font-display); font-size: 32px; font-weight: 700; margin-bottom: 4px; }
.lawyer-stat-label { font-size: 12px; color: rgba(255,255,255,0.45); font-weight: 500; }
.lawyer-right { background: rgba(255,255,255,0.04); border-radius: 20px; padding: 32px; }
.lawyer-feature { display: flex; align-items: flex-start; gap: 14px; margin-bottom: 20px; }
.lawyer-feature:last-child { margin-bottom: 0; }
.lawyer-feature-icon {
  width: 40px; height: 40px; border-radius: 10px; flex-shrink: 0;
  background: rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center;
  color: rgba(255,255,255,0.6);
}
.lawyer-feature-title { font-size: 14px; font-weight: 700; margin-bottom: 3px; }
.lawyer-feature-desc { font-size: 13px; color: rgba(255,255,255,0.5); line-height: 1.5; }

/* TEAM SECTION */
.team-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
.team-card {
  background: var(--surface); border-radius: var(--r-xl); padding: 32px 28px;
  transition: all 0.2s var(--ease); text-align: center;
}
.team-card:hover { background: var(--white); box-shadow: var(--shadow-lg); transform: translateY(-4px); }
.team-avatar {
  width: 72px; height: 72px; border-radius: 50%;
  margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;
  font-size: 22px; font-weight: 700; font-family: var(--font-display);
}
.team-role-tag {
  display: inline-block; padding: 4px 12px; border-radius: 100px;
  font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase;
  margin-bottom: 12px;
}
.team-name { font-family: var(--font-display); font-size: 22px; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.01em; }
.team-title { font-size: 14px; color: var(--text-3); margin-bottom: 14px; }
.team-bio { font-size: 13px; color: var(--text-2); line-height: 1.65; }

/* FAQ */
.faq-item {
  border-bottom: 1px solid var(--border); padding: 22px 0; cursor: pointer;
}
.faq-item:last-child { border-bottom: none; }
.faq-q {
  display: flex; align-items: center; justify-content: space-between; gap: 16px;
  font-size: 16px; font-weight: 600; line-height: 1.4;
}
.faq-q-icon { flex-shrink: 0; width: 28px; height: 28px; border-radius: 50%; background: var(--surface); display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text-2); }
.faq-a { font-size: 14px; color: var(--text-2); line-height: 1.75; margin-top: 14px; display: none; padding-right: 44px; }
.faq-item.open .faq-a { display: block; }
.faq-item.open .faq-q-icon { background: var(--red-soft); color: var(--red); transform: rotate(45deg); }

/* CTA SECTION */
.cta-section {
  background: var(--dark); border-radius: 28px;
  padding: 64px 48px; text-align: center; color: white;
}
.cta-title { font-family: var(--font-display); font-size: clamp(28px, 4vw, 48px); font-weight: 700; margin-bottom: 16px; color: white; letter-spacing: -0.02em; line-height: 1.1; }
.cta-sub { font-size: 17px; color: rgba(255,255,255,0.6); margin-bottom: 36px; max-width: 480px; margin-left: auto; margin-right: auto; line-height: 1.65; }
.cta-btns { display: flex; align-items: center; gap: 12px; justify-content: center; flex-wrap: wrap; }

/* FOOTER */
footer {
  background: var(--off-white); border-top: 1px solid var(--border);
  padding: 60px 24px 32px; position: relative; z-index: 1;
}
.footer-inner { max-width: 1100px; margin: 0 auto; }
.footer-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 48px; margin-bottom: 48px; }
.footer-logo { font-family: var(--font-display); font-size: 22px; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.02em; }
.footer-desc { font-size: 13px; color: var(--text-3); line-height: 1.7; max-width: 260px; margin-bottom: 16px; }
.footer-flag { display: flex; width: 32px; height: 22px; border-radius: 3px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 16px; }
.footer-flag-white { flex: 1; background: white; }
.footer-flag-red { flex: 1; background: var(--red); }
.footer-col h5 { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-3); margin-bottom: 14px; }
.footer-col a { display: block; font-size: 13px; color: var(--text-3); text-decoration: none; margin-bottom: 9px; cursor: pointer; transition: color 0.15s; }
.footer-col a:hover { color: var(--text); }
.footer-bottom {
  display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;
  padding-top: 24px; border-top: 1px solid var(--border);
  font-size: 12px; color: var(--text-4);
}

/* ═══ AUTH PAGE ═══ */
.auth-page {
  min-height: 100vh; display: flex; align-items: center; justify-content: center;
  padding: 80px 20px 40px; background: var(--off-white);
}
.auth-card {
  width: 100%; max-width: 460px;
  background: var(--white); border-radius: var(--r-xl);
  padding: 44px 40px; box-shadow: var(--shadow-lg); border: 1px solid var(--border);
}
.auth-logo { margin-bottom: 28px; }
.auth-title { font-family: var(--font-display); font-size: 28px; font-weight: 700; margin-bottom: 6px; letter-spacing: -0.02em; }
.auth-sub { font-size: 15px; color: var(--text-2); margin-bottom: 28px; }
.auth-tabs { display: flex; gap: 4px; background: var(--surface); border-radius: 12px; padding: 4px; margin-bottom: 24px; }
.auth-tab {
  flex: 1; padding: 10px; border-radius: 9px; border: none;
  background: transparent; color: var(--text-3);
  font-family: var(--font-body); font-size: 14px; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.auth-tab.active { background: var(--white); color: var(--text); box-shadow: var(--shadow-sm); }
.auth-divider { display: flex; align-items: center; gap: 12px; margin: 20px 0; }
.auth-divider::before, .auth-divider::after { content:""; flex:1; height:1px; background: var(--border); }
.auth-divider span { font-size: 12px; color: var(--text-3); }
.auth-switch { text-align: center; margin-top: 20px; font-size: 13px; color: var(--text-3); }
.auth-switch a { color: var(--red); cursor: pointer; font-weight: 600; text-decoration: none; }

/* ═══ CLIENT DASHBOARD ═══ */
.dash-layout { display: flex; min-height: 100vh; }
.dash-sidebar {
  width: 256px; flex-shrink: 0; position: fixed; left: 0; top: 0; bottom: 0;
  background: var(--white); border-right: 1px solid var(--border);
  display: flex; flex-direction: column; padding: 20px 12px; z-index: 50; overflow-y: auto;
}
.dash-logo {
  font-family: var(--font-display); font-size: 19px; font-weight: 700;
  padding: 10px 12px; margin-bottom: 20px; cursor: pointer; letter-spacing: -0.02em;
}
.dash-logo .accent { color: var(--red); }
.dash-nav { flex: 1; }
.dash-nav-label {
  font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase;
  color: var(--text-4); padding: 0 12px; margin-bottom: 4px; margin-top: 16px;
}
.dash-nav-item {
  display: flex; align-items: center; gap: 9px;
  padding: 10px 12px; border-radius: var(--r); font-size: 14px; font-weight: 500;
  color: var(--text-2); cursor: pointer; transition: all 0.15s; text-decoration: none;
  margin-bottom: 2px; border: none; background: transparent; font-family: var(--font-body);
  width: 100%; text-align: left;
}
.dash-nav-item:hover { background: var(--surface); color: var(--text); }
.dash-nav-item.active { background: var(--red-soft); color: var(--red); font-weight: 600; }
.dash-nav-item svg { width: 17px; height: 17px; flex-shrink: 0; }
.dash-user { border-top: 1px solid var(--border); padding-top: 14px; margin-top: 14px; }
.dash-user-row { display: flex; align-items: center; gap: 9px; padding: 10px 12px; }
.dash-main { flex: 1; margin-left: 256px; padding: 28px 28px; min-height: 100vh; background: var(--off-white); }
.dash-topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
.dash-page-title { font-family: var(--font-display); font-size: 26px; font-weight: 700; letter-spacing: -0.02em; }
.dash-page-sub { font-size: 14px; color: var(--text-3); margin-top: 2px; }

/* STATS */
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
.stat-card {
  background: var(--white); border-radius: var(--r-lg); padding: 22px;
  border: 1px solid var(--border); box-shadow: var(--shadow-sm);
}
.stat-label { font-size: 12px; color: var(--text-3); margin-bottom: 6px; font-weight: 600; letter-spacing: 0.03em; }
.stat-value { font-family: var(--font-display); font-size: 30px; font-weight: 700; line-height: 1; letter-spacing: -0.02em; }
.stat-change { font-size: 12px; margin-top: 6px; font-weight: 600; }
.stat-up { color: var(--success); }

/* PROGRESS STEPS */
.progress-steps { display: flex; gap: 0; margin-bottom: 28px; }
.progress-step { flex: 1; text-align: center; position: relative; padding-bottom: 20px; }
.progress-step::before {
  content: ""; position: absolute; top: 13px; left: -50%; right: 50%;
  height: 2px; background: var(--border); z-index: 0;
}
.progress-step:first-child::before { display: none; }
.progress-step.done::before { background: var(--red); }
.ps-dot {
  width: 28px; height: 28px; border-radius: 50%;
  background: var(--surface); border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 8px; position: relative; z-index: 1;
  color: var(--text-3);
}
.progress-step.done .ps-dot { background: var(--red); border-color: var(--red); color: white; }
.progress-step.active .ps-dot { background: var(--white); border-color: var(--red); color: var(--red); box-shadow: 0 0 0 3px var(--red-soft); }
.ps-label { font-size: 11px; font-weight: 600; color: var(--text-3); }
.progress-step.done .ps-label, .progress-step.active .ps-label { color: var(--text); }

/* DATA TABLE */
.data-table { width: 100%; border-collapse: collapse; }
.data-table th {
  text-align: left; padding: 10px 14px; font-size: 11px; font-weight: 700;
  letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-3);
  border-bottom: 1px solid var(--border); background: var(--surface);
}
.data-table td { padding: 14px 14px; font-size: 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.data-table tr:last-child td { border-bottom: none; }
.data-table tr:hover td { background: var(--off-white); }

/* DOCUMENT UPLOAD */
.doc-upload-zone {
  border: 2px dashed var(--border-strong); border-radius: var(--r-lg);
  padding: 40px; text-align: center; cursor: pointer;
  transition: all 0.2s; background: var(--surface);
}
.doc-upload-zone:hover { border-color: var(--red); background: var(--red-soft); }

/* MOBILE DASH */
.dash-mobile-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--white); border-top: 1px solid var(--border);
  padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
  z-index: 100; box-shadow: 0 -4px 16px rgba(0,0,0,0.06);
}
.dash-mobile-nav-inner { display: flex; align-items: center; justify-content: space-around; }
.dash-mob-item {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  padding: 6px 12px; border-radius: var(--r); cursor: pointer; transition: all 0.15s;
  border: none; background: transparent; font-family: var(--font-body); flex: 1;
}
.dash-mob-item.active { color: var(--red); }
.dash-mob-item svg { width: 22px; height: 22px; }
.dash-mob-label { font-size: 10px; font-weight: 600; }

/* ADMIN SPECIFIC */
.admin-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 20px; }

/* ═══ RESPONSIVE ═══ */
@media (max-width: 1024px) {
  .hero-inner { grid-template-columns: 1fr; gap: 40px; }
  .hero-app { display: none; }
  .pricing-grid { grid-template-columns: 1fr; max-width: 480px; }
  .pricing-card.featured { transform: none; }
  .lawyer-section { grid-template-columns: 1fr; gap: 32px; }
  .team-grid { grid-template-columns: 1fr 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}
@media (max-width: 768px) {
  .nav-center { display: none; }
  .nav-actions .btn:not(.btn-primary) { display: none; }
  .nav-menu-btn { display: flex; }
  .steps-grid { grid-template-columns: 1fr 1fr; }
  .feature-grid { grid-template-columns: 1fr 1fr; }
  .testimonials-grid { grid-template-columns: 1fr; }
  .team-grid { grid-template-columns: 1fr; }
  .footer-grid { grid-template-columns: 1fr 1fr; gap: 32px; }
  .cta-section { padding: 40px 24px; }
  .dash-sidebar { display: none; }
  .dash-main { margin-left: 0; padding: 20px 16px 100px; }
  .dash-mobile-nav { display: block; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .section { padding: 60px 20px; }
  .hero { padding: 70px 20px 48px; }
  .auth-card { padding: 32px 24px; }
}
@media (max-width: 480px) {
  .steps-grid { grid-template-columns: 1fr; }
  .feature-grid { grid-template-columns: 1fr; }
  .team-grid { grid-template-columns: 1fr; }
  .footer-grid { grid-template-columns: 1fr; }
  .hero-ctas { flex-direction: column; align-items: stretch; }
  .hero-ctas .btn { justify-content: center; }
}

/* SCROLL REVEAL ANIMATIONS */
.reveal {
  opacity: 0; transform: translateY(24px);
  transition: opacity 0.6s var(--ease-out), transform 0.6s var(--ease-out);
}
.reveal.visible { opacity: 1; transform: none; }
.reveal-delay-1 { transition-delay: 0.1s; }
.reveal-delay-2 { transition-delay: 0.2s; }
.reveal-delay-3 { transition-delay: 0.3s; }
.reveal-delay-4 { transition-delay: 0.4s; }

/* NOTIFICATION DOT */
.notif-dot {
  width: 8px; height: 8px; border-radius: 50%; background: var(--red);
  margin-left: auto; flex-shrink: 0; animation: pulse-dot 2s infinite;
}
@keyframes pulse-dot { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.3); } }

</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div id="toast-container"></div>

<!-- ════════════════════════════
     NAVIGATION
════════════════════════════ -->
<nav class="nav" id="main-nav">
  <div class="nav-logo" onclick="goToLanding()">
    Karta<span class="accent">Flow</span>
  </div>
  <div class="nav-center">
    <button class="nav-link" onclick="scrollToSection('how-it-works')">How it works</button>
    <button class="nav-link" onclick="scrollToSection('what-you-get')">What you get</button>
    <button class="nav-link" onclick="scrollToSection('pricing')">Pricing</button>
    <button class="nav-link" onclick="scrollToSection('team')">Our team</button>
    <button class="nav-link" onclick="scrollToSection('faq')">FAQ</button>
  </div>
  <div class="nav-actions">
    <button class="btn btn-ghost btn-sm" onclick="showAuthPage('login')">Sign in</button>
    <button class="btn btn-primary btn-sm" onclick="scrollToSection('pricing')">
      <i data-lucide="arrow-right" style="width:14px;height:14px"></i>
      Get started
    </button>
    <button class="nav-menu-btn" id="nav-menu-btn" onclick="openMobileMenu()">
      <i data-lucide="menu"></i>
    </button>
  </div>
</nav>

<!-- MOBILE MENU -->
<div class="mobile-menu" id="mobile-menu" onclick="closeMobileMenu(event)">
  <div class="mobile-menu-sheet">
    <div class="mobile-menu-header">
      <span style="font-family:var(--font-display);font-size:18px;font-weight:700">Karta<span style="color:var(--red)">Flow</span></span>
      <button class="btn btn-ghost btn-sm" onclick="closeMobileMenuDirect()" style="padding:8px">
        <i data-lucide="x"></i>
      </button>
    </div>
    <div class="mobile-nav-links">
      <button class="mobile-nav-link" onclick="closeMobileMenuDirect();scrollToSection('how-it-works')">
        <i data-lucide="layers"></i> How it works
      </button>
      <button class="mobile-nav-link" onclick="closeMobileMenuDirect();scrollToSection('what-you-get')">
        <i data-lucide="gift"></i> What you get
      </button>
      <button class="mobile-nav-link" onclick="closeMobileMenuDirect();scrollToSection('pricing')">
        <i data-lucide="tag"></i> Pricing
      </button>
      <button class="mobile-nav-link" onclick="closeMobileMenuDirect();scrollToSection('team')">
        <i data-lucide="users"></i> Our team
      </button>
      <button class="mobile-nav-link" onclick="closeMobileMenuDirect();scrollToSection('faq')">
        <i data-lucide="help-circle"></i> FAQ
      </button>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px">
      <button class="btn btn-outline btn-full" onclick="closeMobileMenuDirect();showAuthPage('login')">Sign in</button>
      <button class="btn btn-primary btn-full" onclick="closeMobileMenuDirect();scrollToSection('pricing')">
        Get started <i data-lucide="arrow-right" style="width:15px;height:15px"></i>
      </button>
    </div>
  </div>
</div>

<!-- ════════════════════════════
     LANDING PAGE
════════════════════════════ -->
<div id="page-landing" class="page active">

  <!-- HERO -->
  <section class="hero">
    <div class="hero-inner">
      <!-- Left -->
      <div class="hero-left" style="position:relative;z-index:1">
        <div class="hero-eyebrow reveal">
          <i data-lucide="shield-check" style="width:13px;height:13px"></i>
          Lawyer-verified · Poland TRC support
        </div>
        <h1 class="display-xl hero-title reveal reveal-delay-1">
          Your Polish<br>residency.<br><em>Finally<br>under control.</em>
        </h1>
        <p class="hero-sub reveal reveal-delay-2">
          We help foreigners in Poland prepare and submit their TRC (Karta Pobytu) application — with a real, licensed immigration lawyer checking every document before you submit.
        </p>
        <div class="hero-ctas reveal reveal-delay-3">
          <button class="btn btn-primary btn-lg" onclick="scrollToSection('pricing')">
            Start my application
            <i data-lucide="arrow-right"></i>
          </button>
          <button class="btn btn-outline btn-lg" onclick="scrollToSection('how-it-works')">
            How it works
          </button>
        </div>
        <div class="hero-trust reveal reveal-delay-4">
          <div class="trust-item">
            <i data-lucide="check-circle"></i>
            Licensed lawyer review
          </div>
          <div class="trust-item">
            <i data-lucide="check-circle"></i>
            98% success rate
          </div>
          <div class="trust-item">
            <i data-lucide="check-circle"></i>
            GDPR · EU servers
          </div>
          <div class="trust-item">
            <i data-lucide="check-circle"></i>
            24h SLA guarantee
          </div>
        </div>
      </div>

      <!-- Right: App Preview -->
      <div class="hero-app reveal reveal-delay-2">
        <div class="app-topbar">
          <div class="app-dots">
            <div class="app-dot r"></div>
            <div class="app-dot y"></div>
            <div class="app-dot g"></div>
          </div>
          <div class="app-topbar-url">kartaflow.pl · dashboard</div>
        </div>
        <div class="app-body">
          <div class="app-case-header">
            <div>
              <div style="font-size:15px;font-weight:700;letter-spacing:-0.01em">Work TRC Application</div>
              <div class="app-case-id">#KF-2025-047 · Tier 2</div>
            </div>
            <span class="badge badge-amber">
              <i data-lucide="clock" style="width:11px;height:11px"></i>
              In Review
            </span>
          </div>
          <div class="app-progress-label">
            <span>Application progress</span>
            <small>3 of 5 steps</small>
          </div>
          <div class="app-progress"><div class="app-progress-fill"></div></div>

          <div class="app-step">
            <div class="app-step-icon done">
              <i data-lucide="check" style="width:16px;height:16px"></i>
            </div>
            <div>
              <div class="app-step-title">Documents uploaded</div>
              <div class="app-step-sub">Passport, employment contract, salary slips</div>
            </div>
            <span class="badge badge-green app-step-badge">Done</span>
          </div>

          <div class="app-step">
            <div class="app-step-icon done">
              <i data-lucide="check" style="width:16px;height:16px"></i>
            </div>
            <div>
              <div class="app-step-title">AI document check</div>
              <div class="app-step-sub">All documents readable · Annex valid</div>
            </div>
            <span class="badge badge-green app-step-badge">Done</span>
          </div>

          <div class="app-step" style="border-color:rgba(232,19,42,0.25);background:rgba(232,19,42,0.03)">
            <div class="app-step-icon active">
              <i data-lucide="scale" style="width:16px;height:16px"></i>
            </div>
            <div>
              <div class="app-step-title">Lawyer review</div>
              <div class="app-step-sub">Olena Harkusha · Response by tomorrow</div>
            </div>
            <span class="badge badge-red app-step-badge">Active</span>
          </div>

          <div class="app-step" style="opacity:0.5">
            <div class="app-step-icon pending">
              <i data-lucide="file-check" style="width:16px;height:16px"></i>
            </div>
            <div>
              <div class="app-step-title">Final review & approval</div>
              <div class="app-step-sub">Sign-off before submission</div>
            </div>
            <span class="badge badge-grey app-step-badge">Next</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PROOF BAR -->
  <div class="proof-bar">
    <div class="proof-track">
      <div class="proof-item"><i data-lucide="users"></i><strong>2,400+</strong> applications supported</div>
      <div class="proof-item"><i data-lucide="star"></i><strong>98%</strong> success rate</div>
      <div class="proof-item"><i data-lucide="shield"></i>Licensed immigration lawyer on every case</div>
      <div class="proof-item"><i data-lucide="clock"></i><strong>24h</strong> lawyer response guarantee</div>
      <div class="proof-item"><i data-lucide="globe"></i>AES-256 encryption · EU servers · GDPR</div>
      <div class="proof-item"><i data-lucide="flag"></i>Built for foreigners living in Poland</div>
      <div class="proof-item"><i data-lucide="users"></i><strong>2,400+</strong> applications supported</div>
      <div class="proof-item"><i data-lucide="star"></i><strong>98%</strong> success rate</div>
      <div class="proof-item"><i data-lucide="shield"></i>Licensed immigration lawyer on every case</div>
      <div class="proof-item"><i data-lucide="clock"></i><strong>24h</strong> lawyer response guarantee</div>
      <div class="proof-item"><i data-lucide="globe"></i>AES-256 encryption · EU servers · GDPR</div>
      <div class="proof-item"><i data-lucide="flag"></i>Built for foreigners living in Poland</div>
    </div>
  </div>

  <!-- HOW IT WORKS -->
  <section class="section" id="how-it-works">
    <div class="container">
      <div class="section-eyebrow">
        <span class="label-red"><i data-lucide="layers" style="width:13px;height:13px"></i> How it works</span>
      </div>
      <h2 class="display-lg section-title reveal">Four steps to your<br>approved <em>Karta Pobytu</em></h2>
      <p class="section-sub reveal">No guessing. No missing documents. No stress. You follow the steps — we handle the complexity.</p>

      <div class="steps-grid reveal">
        <div class="step-card">
          <div class="step-num">01</div>
          <div class="step-icon-wrap">
            <i data-lucide="clipboard-list"></i>
          </div>
          <div class="step-title">Tell us your situation</div>
          <div class="step-desc">Answer a short intake form about your job, family, and permit type. We identify exactly which documents you need — in plain language.</div>
        </div>
        <div class="step-card">
          <div class="step-num">02</div>
          <div class="step-icon-wrap">
            <i data-lucide="upload-cloud"></i>
          </div>
          <div class="step-title">Upload your documents</div>
          <div class="step-desc">Our system checks each document for completeness, validity, and common errors — before a human ever looks at it.</div>
        </div>
        <div class="step-card">
          <div class="step-num">03</div>
          <div class="step-icon-wrap">
            <i data-lucide="scale"></i>
          </div>
          <div class="step-title">Lawyer reviews everything</div>
          <div class="step-desc">A licensed Polish immigration lawyer — Olena Harkusha — personally reviews your documents and sends clear, written feedback.</div>
        </div>
        <div class="step-card">
          <div class="step-num">04</div>
          <div class="step-icon-wrap">
            <i data-lucide="send"></i>
          </div>
          <div class="step-title">Submit with confidence</div>
          <div class="step-desc">Your application is approved for submission. You walk into the Voivodeship office knowing everything is correct.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- WHAT YOU GET -->
  <section class="section" id="what-you-get" style="background:var(--off-white)">
    <div class="container">
      <div class="section-eyebrow">
        <span class="label-red"><i data-lucide="gift" style="width:13px;height:13px"></i> What you get</span>
      </div>
      <h2 class="display-lg section-title reveal">Everything you need.<br><em>Nothing you don't.</em></h2>
      <p class="section-sub reveal">KartaFlow is not a course or a chatbot. It is a full-service application support tool with a real lawyer at the center.</p>

      <div class="feature-grid">
        <div class="feature-card reveal reveal-delay-1">
          <div class="feature-icon"><i data-lucide="clipboard-check"></i></div>
          <div class="feature-title">Smart document checklist</div>
          <div class="feature-desc">Your personal checklist is built from your answers. You only see the documents that apply to your case — no generic lists, no confusion.</div>
        </div>
        <div class="feature-card reveal reveal-delay-2">
          <div class="feature-icon"><i data-lucide="cpu"></i></div>
          <div class="feature-title">AI document validation</div>
          <div class="feature-desc">Before your lawyer sees anything, our system automatically checks every file for common errors — wrong dates, missing stamps, unreadable scans.</div>
        </div>
        <div class="feature-card reveal reveal-delay-3">
          <div class="feature-icon"><i data-lucide="scale"></i></div>
          <div class="feature-title">Licensed lawyer review</div>
          <div class="feature-desc">A qualified Polish immigration lawyer (Radca Prawny) reads your actual documents and gives written feedback — not a template reply.</div>
        </div>
        <div class="feature-card reveal reveal-delay-1">
          <div class="feature-icon"><i data-lucide="message-circle"></i></div>
          <div class="feature-title">Direct messaging</div>
          <div class="feature-desc">Ask your lawyer questions directly inside the platform. All communication is encrypted and stored for your records.</div>
        </div>
        <div class="feature-card reveal reveal-delay-2">
          <div class="feature-icon"><i data-lucide="bell"></i></div>
          <div class="feature-title">Real-time status updates</div>
          <div class="feature-desc">You always know where your application is. No chasing emails. Push notifications and a clear dashboard — phone and desktop.</div>
        </div>
        <div class="feature-card reveal reveal-delay-3">
          <div class="feature-icon"><i data-lucide="lock"></i></div>
          <div class="feature-title">Bank-grade security</div>
          <div class="feature-desc">Your documents are encrypted at rest (AES-256) and in transit (TLS 1.3). Stored only on EU servers. Lawyers review documents in a secure viewer — never downloaded.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- LAWYER SECTION -->
  <section class="section">
    <div class="container">
      <div class="lawyer-section reveal">
        <div>
          <span class="label-xs" style="color:rgba(255,255,255,0.4);display:block;margin-bottom:20px;letter-spacing:0.12em;text-transform:uppercase;font-size:11px">Your immigration lawyer</span>
          <div class="lawyer-badge">OH</div>
          <div class="lawyer-name">Olena Harkusha</div>
          <div class="lawyer-title">Licensed Immigration Lawyer (Radca Prawny) · Poland</div>
          <p class="lawyer-desc">
            Olena is a qualified Polish immigration specialist with years of experience helping foreigners navigate the Polish residence permit system. She personally reviews every document submitted through KartaFlow.
          </p>
          <div style="display:flex;gap:16px;flex-wrap:wrap">
            <a href="https://www.legalnopl.com/" target="_blank" class="btn btn-outline btn-sm" style="border-color:rgba(255,255,255,0.2);color:rgba(255,255,255,0.8)">
              <i data-lucide="globe" style="width:14px;height:14px"></i>
              legalnopl.com
            </a>
            <a href="https://www.instagram.com/legal_trc_poland" target="_blank" class="btn btn-outline btn-sm" style="border-color:rgba(255,255,255,0.2);color:rgba(255,255,255,0.8)">
              <i data-lucide="instagram" style="width:14px;height:14px"></i>
              @legal_trc_poland
            </a>
          </div>
          <div class="lawyer-stats" style="margin-top:32px">
            <div>
              <div class="lawyer-stat-num">2,400+</div>
              <div class="lawyer-stat-label">Cases reviewed</div>
            </div>
            <div>
              <div class="lawyer-stat-num">98%</div>
              <div class="lawyer-stat-label">Success rate</div>
            </div>
            <div>
              <div class="lawyer-stat-num">24h</div>
              <div class="lawyer-stat-label">Response SLA</div>
            </div>
          </div>
        </div>
        <div class="lawyer-right">
          <div class="lawyer-feature">
            <div class="lawyer-feature-icon"><i data-lucide="file-search"></i></div>
            <div>
              <div class="lawyer-feature-title">Document-by-document review</div>
              <div class="lawyer-feature-desc">Every file you upload is read individually. You receive specific, actionable feedback — not a generic checklist.</div>
            </div>
          </div>
          <div class="lawyer-feature">
            <div class="lawyer-feature-icon"><i data-lucide="shield-check"></i></div>
            <div>
              <div class="lawyer-feature-title">Protected legal relationship</div>
              <div class="lawyer-feature-desc">You sign a formal engagement letter. This creates a real lawyer-client relationship protected by Polish law.</div>
            </div>
          </div>
          <div class="lawyer-feature">
            <div class="lawyer-feature-icon"><i data-lucide="phone-call"></i></div>
            <div>
              <div class="lawyer-feature-title">Strategy calls (Tier 3)</div>
              <div class="lawyer-feature-desc">On the top tier, you get a 1-on-1 video call with Olena to discuss your case and strategy before submitting.</div>
            </div>
          </div>
          <div class="lawyer-feature">
            <div class="lawyer-feature-icon"><i data-lucide="refresh-cw"></i></div>
            <div>
              <div class="lawyer-feature-title">Multiple review cycles</div>
              <div class="lawyer-feature-desc">If changes are needed, you revise your documents and resubmit. Your lawyer reviews again until everything is correct.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PRICING -->
  <section class="section" id="pricing" style="background:var(--off-white)">
    <div class="container">
      <div class="section-eyebrow">
        <span class="label-red"><i data-lucide="tag" style="width:13px;height:13px"></i> Pricing</span>
      </div>
      <h2 class="display-lg section-title reveal">Simple, honest<br><em>pricing</em></h2>
      <p class="section-sub reveal">Choose the level of support you need. Every tier includes a real lawyer review. No surprises, no hidden fees.</p>

      <div class="pricing-grid reveal" style="margin:0 auto">
        <!-- TIER 1 -->
        <div class="pricing-card">
          <div class="tier-label dark">Tier 1 · Essential</div>
          <div class="tier-name">Self-guided</div>
          <div class="tier-tagline dark">Good for confident applicants who want a safety check</div>
          <div style="display:flex;align-items:flex-end;gap:4px;margin-bottom:4px">
            <div class="tier-price"><span class="tier-currency">PLN</span>249</div>
          </div>
          <div style="font-size:13px;color:var(--text-3);margin-bottom:24px">one-time payment</div>
          <div class="tier-divider"></div>
          <ul class="tier-features">
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>Smart document checklist (your case)</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>AI document pre-check</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span><strong>1 lawyer review cycle</strong> — written feedback</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>Education hub: guides for your permit type</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>Secure document portal</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="minus-circle" class="tier-check muted" style="width:18px;height:18px"></i>
              <span style="color:var(--text-4)">No messaging with lawyer</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="minus-circle" class="tier-check muted" style="width:18px;height:18px"></i>
              <span style="color:var(--text-4)">No video call</span>
            </li>
          </ul>
          <button class="btn btn-outline btn-full btn-lg" onclick="selectTier('tier1')">
            Choose Essential
            <i data-lucide="arrow-right"></i>
          </button>
        </div>

        <!-- TIER 2 — FEATURED -->
        <div class="pricing-card featured">
          <div class="popular-tag">Most popular</div>
          <div class="tier-label light">Tier 2 · Complete</div>
          <div class="tier-name light">Guided</div>
          <div class="tier-tagline light">The most popular choice — full support without a call</div>
          <div style="display:flex;align-items:flex-end;gap:4px;margin-bottom:4px">
            <div class="tier-price light"><span class="tier-currency">PLN</span>599</div>
          </div>
          <div style="font-size:13px;color:rgba(255,255,255,0.45);margin-bottom:24px">one-time payment</div>
          <div class="tier-divider light"></div>
          <ul class="tier-features">
            <li class="tier-feature light">
              <i data-lucide="check-circle" style="width:18px;height:18px;color:#4ADE80;flex-shrink:0;margin-top:1px"></i>
              <span>Everything in Essential</span>
            </li>
            <li class="tier-feature light">
              <i data-lucide="check-circle" style="width:18px;height:18px;color:#4ADE80;flex-shrink:0;margin-top:1px"></i>
              <span><strong style="color:white">5 lawyer review cycles</strong></span>
            </li>
            <li class="tier-feature light">
              <i data-lucide="check-circle" style="width:18px;height:18px;color:#4ADE80;flex-shrink:0;margin-top:1px"></i>
              <span><strong style="color:white">Direct messaging</strong> with your lawyer</span>
            </li>
            <li class="tier-feature light">
              <i data-lucide="check-circle" style="width:18px;height:18px;color:#4ADE80;flex-shrink:0;margin-top:1px"></i>
              <span>Priority review — <strong style="color:white">24h SLA</strong></span>
            </li>
            <li class="tier-feature light">
              <i data-lucide="check-circle" style="width:18px;height:18px;color:#4ADE80;flex-shrink:0;margin-top:1px"></i>
              <span>Push notifications — phone & desktop</span>
            </li>
            <li class="tier-feature light">
              <i data-lucide="check-circle" style="width:18px;height:18px;color:#4ADE80;flex-shrink:0;margin-top:1px"></i>
              <span>Family member add-on available (+300 PLN)</span>
            </li>
            <li class="tier-feature light">
              <i data-lucide="minus-circle" style="width:18px;height:18px;color:rgba(255,255,255,0.2);flex-shrink:0;margin-top:1px"></i>
              <span style="color:rgba(255,255,255,0.35)">No video strategy call</span>
            </li>
          </ul>
          <button class="btn btn-primary btn-full btn-lg" onclick="selectTier('tier2')" style="background:white;color:var(--dark)">
            Choose Guided
            <i data-lucide="arrow-right"></i>
          </button>
        </div>

        <!-- TIER 3 -->
        <div class="pricing-card">
          <div class="tier-label dark">Tier 3 · Premium</div>
          <div class="tier-name">Full service</div>
          <div class="tier-tagline dark">For complex cases or anyone who wants complete peace of mind</div>
          <div style="display:flex;align-items:flex-end;gap:4px;margin-bottom:4px">
            <div class="tier-price"><span class="tier-currency">PLN</span>999</div>
          </div>
          <div style="font-size:13px;color:var(--text-3);margin-bottom:24px">one-time payment</div>
          <div class="tier-divider"></div>
          <ul class="tier-features">
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>Everything in Guided</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span><strong>Unlimited</strong> review cycles</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span><strong>1:1 video call</strong> with Olena Harkusha</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>Express priority — <strong>12h SLA</strong></span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>Rejection review + appeal guidance</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>Voivodeship appointment strategy</span>
            </li>
            <li class="tier-feature">
              <i data-lucide="check-circle" class="tier-check red" style="width:18px;height:18px"></i>
              <span>Formal engagement letter included</span>
            </li>
          </ul>
          <button class="btn btn-dark btn-full btn-lg" onclick="selectTier('tier3')">
            Choose Full service
            <i data-lucide="arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Tier comparison note -->
      <div style="margin-top:32px;text-align:center" class="reveal">
        <p style="font-size:14px;color:var(--text-3)">
          All tiers include a <strong style="color:var(--text)">signed lawyer engagement letter</strong> creating a protected legal relationship.
          Full refund within 24h if no review has started.
        </p>
        <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-top:16px;flex-wrap:wrap">
          <div class="trust-item"><i data-lucide="check-circle"></i>24h refund policy</div>
          <div class="trust-item"><i data-lucide="check-circle"></i>No subscription — one-time payment</div>
          <div class="trust-item"><i data-lucide="check-circle"></i>Upgrade anytime</div>
        </div>
      </div>
    </div>
  </section>

  <!-- TESTIMONIALS -->
  <section class="section">
    <div class="container">
      <div class="section-eyebrow">
        <span class="label-red"><i data-lucide="star" style="width:13px;height:13px"></i> Real people, real results</span>
      </div>
      <h2 class="display-lg section-title reveal">People who changed<br>their lives in <em>Poland</em></h2>

      <div class="testimonials-grid">
        <div class="testimonial-card reveal reveal-delay-1">
          <div class="stars">
            <i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i>
          </div>
          <p class="testimonial-text">"I had tried twice before and was rejected both times. With KartaFlow, my documents were approved on the first attempt. The lawyer found two mistakes I never would have seen."</p>
          <div class="testimonial-author">
            <div class="avatar avatar-red">AO</div>
            <div>
              <div class="author-name">Adebayo Okonkwo</div>
              <div class="author-meta">Work TRC · Lagos, Nigeria → Warsaw</div>
            </div>
          </div>
        </div>
        <div class="testimonial-card reveal reveal-delay-2">
          <div class="stars">
            <i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i>
          </div>
          <p class="testimonial-text">"I do not speak Polish. The checklist was in English, the lawyer wrote feedback in English. Everything was clear. My whole family got our permits together."</p>
          <div class="testimonial-author">
            <div class="avatar avatar-dark">FD</div>
            <div>
              <div class="author-name">Fatima Diallo</div>
              <div class="author-meta">Family TRC · Dakar → Kraków</div>
            </div>
          </div>
        </div>
        <div class="testimonial-card reveal reveal-delay-3">
          <div class="stars">
            <i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i><i data-lucide="star"></i>
          </div>
          <p class="testimonial-text">"The video call with the lawyer was worth everything. She explained exactly what Wrocław Voivodeship wants, and I walked in completely prepared. Approved in 8 weeks."</p>
          <div class="testimonial-author">
            <div class="avatar" style="background:rgba(59,130,246,0.1);color:#3B82F6">KT</div>
            <div>
              <div class="author-name">Kwame Tetteh</div>
              <div class="author-meta">Work TRC (Business) · Accra → Wrocław</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TEAM SECTION -->
  <section class="section" id="team" style="background:var(--off-white)">
    <div class="container">
      <div class="section-eyebrow">
        <span class="label-red"><i data-lucide="users" style="width:13px;height:13px"></i> The team behind KartaFlow</span>
      </div>
      <h2 class="display-lg section-title reveal">Built by people who<br>care about <em>your future</em></h2>
      <p class="section-sub reveal">KartaFlow was built by a small, passionate team of technologists and legal experts who believe immigration support should be accessible, honest, and human.</p>

      <div class="team-grid">
        <div class="team-card reveal reveal-delay-1">
          <div class="team-avatar" style="background:rgba(232,19,42,0.1);color:var(--red)">MK</div>
          <span class="team-role-tag badge-red">CTO</span>
          <div class="team-name">Marek Kowalski</div>
          <div class="team-title">Chief Technology Officer</div>
          <p class="team-bio">Marek architected the secure document portal and AI validation engine. He ensures every document is protected to banking standards and the platform is fast, reliable, and private.</p>
        </div>
        <div class="team-card reveal reveal-delay-2">
          <div class="team-avatar" style="background:rgba(99,102,241,0.1);color:#6366F1">AN</div>
          <span class="team-role-tag" style="background:rgba(99,102,241,0.1);color:#6366F1;border:1px solid rgba(99,102,241,0.2)">CPO</span>
          <div class="team-name">Anna Nowak</div>
          <div class="team-title">Chief Product Officer</div>
          <p class="team-bio">Anna designed the KartaFlow experience around one principle: no foreign national should ever feel lost in a process that changes their life. She speaks to users every week.</p>
        </div>
        <div class="team-card reveal reveal-delay-3">
          <div class="team-avatar" style="background:rgba(16,185,129,0.1);color:#10B981">PW</div>
          <span class="team-role-tag" style="background:rgba(16,185,129,0.1);color:#10B981;border:1px solid rgba(16,185,129,0.2)">CDO</span>
          <div class="team-name">Piotr Wiśniewski</div>
          <div class="team-title">Chief Data Officer</div>
          <p class="team-bio">Piotr oversees data privacy, GDPR compliance, and the intelligence that powers our document pre-check system. He ensures your data is only ever used to help you.</p>
        </div>
      </div>

      <!-- Lawyer team card -->
      <div class="card reveal" style="margin-top:20px;display:flex;align-items:center;gap:28px;flex-wrap:wrap">
        <div class="avatar" style="width:64px;height:64px;font-size:20px;background:rgba(232,19,42,0.1);color:var(--red);font-family:var(--font-display);font-weight:700;flex-shrink:0">OH</div>
        <div style="flex:1;min-width:220px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
            <div style="font-family:var(--font-display);font-size:18px;font-weight:700;letter-spacing:-0.01em">Olena Harkusha</div>
            <span class="badge badge-red">Immigration Lawyer</span>
          </div>
          <div style="font-size:13px;color:var(--text-3);margin-bottom:6px">Radca Prawny · Licensed in Poland · Specialisation: TRC applications</div>
          <div style="font-size:14px;color:var(--text-2)">The legal heart of KartaFlow. Olena personally reviews every document submitted through the platform. She brings deep knowledge of Polish Voivodeship requirements and a commitment to getting every client to approval.</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;flex-shrink:0">
          <a href="https://www.legalnopl.com/" target="_blank" class="btn btn-outline btn-sm">
            <i data-lucide="globe"></i> legalnopl.com
          </a>
          <a href="https://www.instagram.com/legal_trc_poland" target="_blank" class="btn btn-outline btn-sm">
            <i data-lucide="instagram"></i> Instagram
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- FAQ -->
  <section class="section" id="faq">
    <div class="container">
      <div class="section-eyebrow">
        <span class="label-red"><i data-lucide="help-circle" style="width:13px;height:13px"></i> Questions</span>
      </div>
      <h2 class="display-lg section-title reveal">Answers to the most<br><em>common questions</em></h2>

      <div style="max-width:740px" id="faq-list"></div>
    </div>
  </section>

  <!-- CTA -->
  <section class="section-sm">
    <div class="container">
      <div class="cta-section reveal">
        <div style="display:inline-flex;align-items:center;gap:8px;padding:6px 14px;border-radius:100px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);font-size:12px;color:rgba(255,255,255,0.7);margin-bottom:20px;font-weight:600;letter-spacing:0.06em;text-transform:uppercase">
          <i data-lucide="zap" style="width:12px;height:12px;color:#FBBF24"></i>
          Ready to start?
        </div>
        <h2 class="cta-title">You didn't come this far<br>to get lost in paperwork.</h2>
        <p class="cta-sub">Your Polish residency is possible. KartaFlow gives you the structure, support, and legal expertise to get it done — right the first time.</p>
        <div class="cta-btns">
          <button class="btn btn-primary btn-lg" onclick="scrollToSection('pricing')">
            Start my application
            <i data-lucide="arrow-right"></i>
          </button>
          <button class="btn btn-lg" onclick="showAuthPage('login')" style="background:rgba(255,255,255,0.1);color:white;border:1.5px solid rgba(255,255,255,0.2)">
            I have an account
          </button>
        </div>
        <p style="font-size:13px;color:rgba(255,255,255,0.4);margin-top:20px">Full refund within 24h · No subscription · Upgrade any time</p>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer>
    <div class="footer-inner">
      <div class="footer-grid">
        <div>
          <div class="footer-logo">Karta<span style="color:var(--red)">Flow</span></div>
          <p class="footer-desc">Structured immigration support for foreigners in Poland. Built with a licensed lawyer at the centre.</p>
          <div class="footer-flag"><div class="footer-flag-white"></div><div class="footer-flag-red"></div></div>
          <div style="font-size:12px;color:var(--text-4)">Legal services by Olena Harkusha<br>Licensed immigration lawyer · Poland</div>
        </div>
        <div class="footer-col">
          <h5>Product</h5>
          <a onclick="scrollToSection('how-it-works')">How it works</a>
          <a onclick="scrollToSection('what-you-get')">What you get</a>
          <a onclick="scrollToSection('pricing')">Pricing</a>
          <a onclick="scrollToSection('faq')">FAQ</a>
        </div>
        <div class="footer-col">
          <h5>Legal</h5>
          <a href="https://www.legalnopl.com/" target="_blank">legalnopl.com</a>
          <a href="https://www.instagram.com/legal_trc_poland" target="_blank">@legal_trc_poland</a>
          <a onclick="showToast('Privacy policy coming soon','info')">Privacy policy</a>
          <a onclick="showToast('Terms coming soon','info')">Terms of service</a>
        </div>
        <div class="footer-col">
          <h5>Account</h5>
          <a onclick="showAuthPage('login')">Sign in</a>
          <a onclick="showAuthPage('register')">Create account</a>
          <a onclick="showToast('Support email: support@kartaflow.pl','info')">Support</a>
        </div>
      </div>
      <div class="footer-bottom">
        <span>© 2025 KartaFlow. All rights reserved.</span>
        <span>Legal services: Olena Harkusha, Radca Prawny</span>
        <span style="display:flex;align-items:center;gap:6px">
          <i data-lucide="shield" style="width:13px;height:13px;color:var(--success)"></i>
          GDPR compliant · EU hosted · AES-256
        </span>
      </div>
    </div>
  </footer>

</div><!-- /page-landing -->

<!-- ════════════════════════════
     AUTH PAGE
════════════════════════════ -->
<div id="page-auth" class="page">
  <div class="auth-page">
    <div class="auth-card">
      <div class="auth-logo">
        <span style="font-family:var(--font-display);font-size:20px;font-weight:700;cursor:pointer;letter-spacing:-0.02em" onclick="showPage('landing')">
          Karta<span style="color:var(--red)">Flow</span>
        </span>
      </div>
      <h1 class="auth-title">Welcome back</h1>
      <p class="auth-sub">Sign in to your account or create a new one.</p>
      
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-login" onclick="switchAuthTab('login',this)">Sign in</button>
        <button class="auth-tab" id="tab-register" onclick="switchAuthTab('register',this)">Create account</button>
      </div>

      <!-- LOGIN -->
      <div id="auth-login">
        <div class="form-group">
          <label class="form-label">Email address</label>
          <input type="email" class="form-input" id="login-email" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="login-password" placeholder="Your password">
        </div>
        <button class="btn btn-primary btn-full btn-lg" style="margin-bottom:16px" onclick="handleLogin()">
          <i data-lucide="log-in"></i> Sign in
        </button>

      </div>

      <!-- REGISTER -->
      <div id="auth-register" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="form-group">
            <label class="form-label">First name</label>
            <input type="text" class="form-input" id="reg-first" placeholder="First name">
          </div>
          <div class="form-group">
            <label class="form-label">Last name</label>
            <input type="text" class="form-input" id="reg-last" placeholder="Last name">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Email address</label>
          <input type="email" class="form-input" id="reg-email" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="reg-password" placeholder="Create a password">
          <div class="form-hint">Minimum 8 characters</div>
        </div>
        <button class="btn btn-primary btn-full btn-lg" onclick="handleRegister()">
          <i data-lucide="user-plus"></i> Create account
        </button>
      </div>

      <p class="auth-switch">
        <a onclick="goToLanding()">← Back to home</a>
      </p>
    </div>
  </div>
</div>

<!-- ════════════════════════════
     CLIENT DASHBOARD
════════════════════════════ -->
<div id="page-client" class="page">
  <div class="dash-layout">
    <!-- Sidebar -->
    <aside class="dash-sidebar">
      <div class="dash-logo" onclick="goToLanding()">Karta<span class="accent">Flow</span></div>
      <nav class="dash-nav">
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-4);padding:0 12px;margin-bottom:4px">Application</div>
        <button class="dash-nav-item active" id="c-nav-overview" onclick="clientNav('overview',this)">
          <i data-lucide="layout-dashboard"></i> Overview
        </button>
        <button class="dash-nav-item" id="c-nav-intake" onclick="clientNav('intake',this)">
          <i data-lucide="clipboard-list"></i> Intake Form
        </button>
        <button class="dash-nav-item" id="c-nav-documents" onclick="clientNav('documents',this)">
          <i data-lucide="folder-open"></i> My Documents
          <span class="notif-dot"></span>
        </button>
        <button class="dash-nav-item" id="c-nav-messages" onclick="clientNav('messages',this)">
          <i data-lucide="message-circle"></i> Messages
        </button>
        <button class="dash-nav-item" id="c-nav-booking" onclick="clientNav('booking',this)">
          <i data-lucide="calendar"></i> Book a Call
        </button>
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-4);padding:0 12px;margin-bottom:4px;margin-top:16px">Account</div>
        <button class="dash-nav-item" id="c-nav-billing" onclick="clientNav('billing',this)">
          <i data-lucide="credit-card"></i> Billing
        </button>
        <button class="dash-nav-item" id="c-nav-family" onclick="clientNav('family',this)">
          <i data-lucide="users"></i> Family Members
        </button>
        <button class="dash-nav-item" id="c-nav-referral" onclick="clientNav('referral',this)">
          <i data-lucide="gift"></i> Refer & Earn
        </button>
      </nav>
      <div class="dash-user">
        <div class="dash-user-row">
          <div class="avatar avatar-red" id="client-avatar" style="flex-shrink:0">—</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="client-name">Loading…</div>
            <div style="font-size:11px;color:var(--text-3)" id="client-tier-label">Client</div>
          </div>
        </div>
        <button class="dash-nav-item" onclick="handleLogout()" style="color:var(--text-3)">
          <i data-lucide="log-out"></i> Sign out
        </button>
      </div>
    </aside>

    <!-- Mobile bottom nav -->
    <div class="dash-mobile-nav">
      <div class="dash-mobile-nav-inner">
        <button class="dash-mob-item active" onclick="clientNav('overview',this)">
          <i data-lucide="layout-dashboard"></i>
          <span class="dash-mob-label">Home</span>
        </button>
        <button class="dash-mob-item" onclick="clientNav('documents',this)">
          <i data-lucide="folder-open"></i>
          <span class="dash-mob-label">Documents</span>
        </button>
        <button class="dash-mob-item" onclick="clientNav('messages',this)">
          <i data-lucide="message-circle"></i>
          <span class="dash-mob-label">Messages</span>
        </button>
        <button class="dash-mob-item" onclick="clientNav('billing',this)">
          <i data-lucide="credit-card"></i>
          <span class="dash-mob-label">Billing</span>
        </button>
      </div>
    </div>

    <main class="dash-main" id="client-main"></main>
  </div>
</div>

<!-- ════════════════════════════
     SPECIALIST DASHBOARD
════════════════════════════ -->
<div id="page-specialist" class="page">
  <div class="dash-layout">
    <aside class="dash-sidebar">
      <div class="dash-logo" onclick="goToLanding()">Karta<span class="accent">Flow</span></div>
      <nav class="dash-nav">
        <button class="dash-nav-item active" id="sp-nav-cases" onclick="specialistNav('cases',this)">
          <i data-lucide="folder-open"></i> Cases
        </button>
      </nav>
      <div class="dash-user">
        <div class="dash-user-row">
          <div class="avatar" style="background:rgba(217,119,6,0.1);color:var(--warning);flex-shrink:0;font-weight:700" id="specialist-avatar-sp">SP</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" id="specialist-name-sp">Specialist</div>
            <div style="font-size:11px;color:var(--text-3)" id="specialist-role-sp">Specialist</div>
          </div>
        </div>
        <button class="dash-nav-item" onclick="handleLogout()" style="color:var(--text-3)">
          <i data-lucide="log-out"></i> Sign out
        </button>
      </div>
    </aside>
    <main class="dash-main" id="specialist-main"></main>
  </div>
</div>

<!-- ════════════════════════════
     LAWYER DASHBOARD
════════════════════════════ -->
<div id="page-lawyer" class="page">
  <div class="dash-layout">
    <aside class="dash-sidebar">
      <div class="dash-logo" onclick="goToLanding()">Karta<span class="accent">Flow</span></div>
      <nav class="dash-nav">
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-4);padding:0 12px;margin-bottom:4px">Review Work</div>
        <button class="dash-nav-item active" onclick="lawyerNav('queue',this)">
          <i data-lucide="inbox"></i> Client Queue
          <span class="badge badge-red" style="margin-left:auto">8</span>
        </button>
        <button class="dash-nav-item" onclick="lawyerNav('review',this)">
          <i data-lucide="file-search"></i> Active Review
        </button>
        <button class="dash-nav-item" onclick="lawyerNav('completed',this)">
          <i data-lucide="check-circle"></i> Completed
        </button>
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-4);padding:0 12px;margin-bottom:4px;margin-top:16px">Manage</div>
        <button class="dash-nav-item" onclick="lawyerNav('calendar',this)">
          <i data-lucide="calendar"></i> Calendar
        </button>
        <button class="dash-nav-item" onclick="lawyerNav('metrics',this)">
          <i data-lucide="bar-chart-2"></i> My Metrics
        </button>
      </nav>
      <div class="dash-user">
        <div class="dash-user-row">
          <div class="avatar" style="background:rgba(217,119,6,0.1);color:var(--warning);flex-shrink:0;font-weight:700">OH</div>
          <div>
            <div style="font-size:14px;font-weight:700" id="specialist-name">Specialist</div>
            <div style="font-size:11px;color:var(--text-3)">Radca Prawny</div>
          </div>
        </div>
        <button class="dash-nav-item" onclick="handleLogout()" style="color:var(--text-3)">
          <i data-lucide="log-out"></i> Sign out
        </button>
      </div>
    </aside>
    <main class="dash-main" id="lawyer-main"></main>
  </div>
</div>

<!-- ════════════════════════════
     ADMIN PANEL
════════════════════════════ -->
<div id="page-admin" class="page">
  <div class="dash-layout">
    <aside class="dash-sidebar">
      <div class="dash-logo" onclick="goToLanding()">Karta<span class="accent">Flow</span></div>
      <nav class="dash-nav">
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-4);padding:0 12px;margin-bottom:4px">Overview</div>
        <button class="dash-nav-item active" onclick="adminNav('dashboard',this)">
          <i data-lucide="layout-dashboard"></i> Dashboard
        </button>
        <button class="dash-nav-item" onclick="adminNav('clients',this)">
          <i data-lucide="users"></i> All Clients
        </button>
        <button class="dash-nav-item" onclick="adminNav('lawyers',this)">
          <i data-lucide="scale"></i> Lawyers
        </button>
        <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-4);padding:0 12px;margin-bottom:4px;margin-top:16px">Operations</div>
        <button class="dash-nav-item" onclick="adminNav('revenue',this)">
          <i data-lucide="trending-up"></i> Revenue
        </button>
        <button class="dash-nav-item" onclick="adminNav('promos',this)">
          <i data-lucide="tag"></i> Promo Codes
        </button>
        <button class="dash-nav-item" onclick="adminNav('refunds',this)">
          <i data-lucide="rotate-ccw"></i> Refunds
        </button>
        <button class="dash-nav-item" onclick="adminNav('audit',this)">
          <i data-lucide="shield"></i> Audit Log
        </button>
      </nav>
      <div class="dash-user">
        <div class="dash-user-row">
          <div class="avatar avatar-red" style="flex-shrink:0;font-weight:700">AD</div>
          <div>
            <div style="font-size:14px;font-weight:700">Admin</div>
            <div style="font-size:11px;color:var(--text-3)">Super Admin</div>
          </div>
        </div>
        <button class="dash-nav-item" onclick="handleLogout()" style="color:var(--text-3)">
          <i data-lucide="log-out"></i> Sign out
        </button>
      </div>
    </aside>
    <main class="dash-main" id="admin-main"></main>
  </div>
</div>


<!-- ════════════════════════════
     PLAN SELECTION (registered / pending payment)
════════════════════════════ -->
<div id="page-plan-selection" class="page">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--off-white)">
    <div style="max-width:480px;width:100%;padding:40px 24px;text-align:center">
      <div style="font-family:var(--font-display);font-size:28px;font-weight:700;margin-bottom:8px">
        Karta<span style="color:var(--red)">Flow</span>
      </div>
      <div style="font-size:15px;color:var(--text-2);margin-bottom:32px">Choose your plan to begin your application</div>
      <div class="card" style="padding:32px;text-align:center">
        <i data-lucide="credit-card" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
        <div style="font-size:16px;font-weight:700;margin-bottom:8px">Payment required</div>
        <div style="font-size:13px;color:var(--text-3);margin-bottom:24px">Select a plan to access your application dashboard. Plan selection and Stripe checkout will be available once backend is connected.</div>
        <button class="btn btn-outline" onclick="handleLogout()"><i data-lucide="log-out"></i> Sign out</button>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════
     QUESTIONNAIRE (paid, questionnaire not done)
════════════════════════════ -->
<div id="page-questionnaire" class="page">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--off-white);padding:40px 0">
    <div style="max-width:620px;width:100%;padding:40px 24px">
      <div style="font-family:var(--font-display);font-size:28px;font-weight:700;margin-bottom:4px;text-align:center">
        Karta<span style="color:var(--red)">Flow</span>
      </div>
      <div style="font-size:15px;color:var(--text-2);margin-bottom:32px;text-align:center">TRC Type Questionnaire</div>
      <div id="questionnaire-back-btn-wrap" style="display:none;margin-bottom:16px;text-align:center">
        <button class="btn btn-ghost btn-sm" onclick="renderApp()" style="color:var(--text-3)">
          <i data-lucide="arrow-left"></i> Back to dashboard
        </button>
      </div>
      <div class="card" style="padding:36px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--border)">
          <i data-lucide="clipboard-list" style="width:28px;height:28px;color:var(--red);flex-shrink:0"></i>
          <div>
            <div id="questionnaire-mode-label" style="font-size:16px;font-weight:700;margin-bottom:2px">Determine your TRC type</div>
            <div style="font-size:13px;color:var(--text-3)">Answer all questions honestly — your specialist will review your case.</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">1. What is your primary reason for being in Poland?</label>
          <select class="form-select" id="q_primary_reason">
            <option value="">— Select an option —</option>
            <option value="work_employment">Employment (contract with Polish employer)</option>
            <option value="work_b2b">Self-employment / B2B / own company</option>
            <option value="family_reunion">Family reunification (joining a family member)</option>
            <option value="study">Studying at a Polish university</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">2. What is your current nationality?</label>
          <input class="form-input" id="q_nationality" type="text" placeholder="e.g. Ukrainian, Indian, Georgian…">
        </div>

        <div class="form-group">
          <label class="form-label">3. Do you currently hold a valid work permit (Zezwolenie na pracę) in Poland?</label>
          <select class="form-select" id="q_work_permit">
            <option value="">— Select an option —</option>
            <option value="yes_type_a">Yes — Type A permit</option>
            <option value="yes_other">Yes — Other type</option>
            <option value="no">No</option>
            <option value="not_applicable">Not applicable (e.g. EU Blue Card, family member)</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">4. How long have you been continuously residing in Poland?</label>
          <select class="form-select" id="q_residence_duration">
            <option value="">— Select an option —</option>
            <option value="less_3_months">Less than 3 months</option>
            <option value="3_to_12_months">3–12 months</option>
            <option value="1_to_3_years">1–3 years</option>
            <option value="over_3_years">More than 3 years</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">5. What is your current legal entry basis into Poland?</label>
          <select class="form-select" id="q_entry_basis">
            <option value="">— Select an option —</option>
            <option value="visa_d">National Visa (D-type)</option>
            <option value="visa_c">Schengen Visa (C-type)</option>
            <option value="visa_free">Visa-free (e.g. Ukrainian, EU national)</option>
            <option value="existing_trc">Existing TRC / residence permit</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">6. Do you have a spouse or child who is a Polish citizen or EU national?</label>
          <select class="form-select" id="q_family_ties">
            <option value="">— Select an option —</option>
            <option value="yes_spouse_polish">Yes — Spouse is a Polish citizen</option>
            <option value="yes_spouse_eu">Yes — Spouse is an EU national</option>
            <option value="yes_child">Yes — Child is a Polish/EU national</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">7. Are you currently enrolled at a Polish university or research institution?</label>
          <select class="form-select" id="q_student_status">
            <option value="">— Select an option —</option>
            <option value="yes_full_time">Yes — full-time student</option>
            <option value="yes_phd">Yes — PhD / doctoral candidate</option>
            <option value="no">No</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">8. Which voivodeship (region) will you be applying in?</label>
          <select class="form-select" id="q_voivodeship">
            <option value="">— Select a voivodeship —</option>
            <option value="masovian">Masovian (Warsaw)</option>
            <option value="lesser_poland">Lesser Poland (Kraków)</option>
            <option value="lower_silesian">Lower Silesian (Wrocław)</option>
            <option value="pomeranian">Pomeranian (Gdańsk)</option>
            <option value="silesian">Silesian (Katowice)</option>
            <option value="greater_poland">Greater Poland (Poznań)</option>
            <option value="lodz">Łódź</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">9. Have you previously had a TRC application rejected in Poland?</label>
          <select class="form-select" id="q_previous_rejection">
            <option value="">— Select an option —</option>
            <option value="no">No</option>
            <option value="yes_once">Yes — once</option>
            <option value="yes_multiple">Yes — more than once</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">10. Is there anything else the specialist should know about your situation? <span style="color:var(--text-4);font-weight:400">(optional)</span></label>
          <textarea class="form-input" id="q_additional_info" rows="3" placeholder="Any additional context, complications, or questions…" style="resize:vertical;min-height:80px"></textarea>
        </div>

        <div style="margin-top:8px;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <button class="btn btn-primary" id="questionnaire-submit-btn" onclick="handleQuestionnaireSubmit()">
            <i data-lucide="send"></i> Submit questionnaire
          </button>
          <button class="btn btn-ghost btn-sm" onclick="handleLogout()" style="color:var(--text-3)">
            <i data-lucide="log-out"></i> Sign out
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════
     BOOK CALL (questionnaire done, call not confirmed)
════════════════════════════ -->
<div id="page-book-call" class="page">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--off-white)">
    <div style="max-width:540px;width:100%;padding:40px 24px">
      <div style="font-family:var(--font-display);font-size:28px;font-weight:700;margin-bottom:4px;text-align:center">
        Karta<span style="color:var(--red)">Flow</span>
      </div>
      <div style="font-size:15px;color:var(--text-2);margin-bottom:32px;text-align:center">Book your confirmation call</div>
      <div class="card" style="padding:32px;text-align:center">
        <i data-lucide="video" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
        <div style="font-size:16px;font-weight:700;margin-bottom:8px">Confirmation call required</div>
        <div style="font-size:13px;color:var(--text-3);margin-bottom:24px">Book a confirmation call with your specialist to verify your TRC type before beginning document upload. Calendar booking will be available once backend is connected.</div>
        <button class="btn btn-outline" onclick="handleLogout()"><i data-lucide="log-out"></i> Sign out</button>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════
     UPGRADE MODAL
════════════════════════════ -->
<div class="modal-overlay" id="upgrade-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeUpgradeModal()">
      <i data-lucide="x"></i>
    </button>

    <div style="text-align:center">
      <div style="margin-bottom:12px;font-weight:700;font-size:20px">
        Activate Your Application
      </div>
      <div style="font-size:14px;color:var(--text-2);margin-bottom:24px">
        Get lawyer review, document validation, and guided submission.
      </div>

      <button class="btn btn-primary btn-full btn-lg" onclick="startStripeCheckout()">
        Continue to Payment
      </button>

      <div style="margin-top:12px;font-size:12px;color:var(--text-3)">
        Secure payment · EU servers · Lawyer engagement included
      </div>
    </div>
  </div>
</div>

<!-- ════════════════════════════
     JAVASCRIPT
════════════════════════════ -->
<script>
// ═══════════════════════════════════════════════════════════════════
// KARTAFLOW — PRODUCTION ARCHITECTURE SKELETON
// Strictly follows kartaflow-master-v1.2 system states.
// Backend wiring: Phase 4.
// ═══════════════════════════════════════════════════════════════════

// ─── INIT LUCIDE ICONS ───
document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); });

// ─── ANIMATED BACKGROUND ───
(function() {
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  let W, H, particles = [];
  function resize() { W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; }
  resize();
  window.addEventListener('resize', resize);
  for (let i = 0; i < 50; i++) {
    particles.push({ x: Math.random()*1000, y: Math.random()*800, vx:(Math.random()-0.5)*0.35, vy:(Math.random()-0.5)*0.35,
      r: Math.random()*1.8+0.5, a: Math.random(), da:(Math.random()-0.5)*0.004, red: Math.random()>0.88 });
  }
  function draw() {
    ctx.clearRect(0,0,W,H);
    function orb(x,y,r,c,a) {
      const g=ctx.createRadialGradient(x*W,y*H,0,x*W,y*H,r);
      g.addColorStop(0,c.replace(')',`,${a})`).replace('rgb','rgba'));
      g.addColorStop(1,'transparent'); ctx.fillStyle=g;
      ctx.beginPath(); ctx.arc(x*W,y*H,r,0,Math.PI*2); ctx.fill();
    }
    orb(0.15,0.25,W*0.28,'rgb(232,19,42',0.04);
    orb(0.88,0.72,W*0.22,'rgb(232,19,42',0.025);
    orb(0.55,0.08,W*0.2,'rgb(0,0,0',0.02);
    for (let i=0;i<particles.length;i++) {
      for (let j=i+1;j<particles.length;j++) {
        const dx=particles[i].x-particles[j].x, dy=particles[i].y-particles[j].y, d=Math.sqrt(dx*dx+dy*dy);
        if (d<110) { ctx.beginPath(); ctx.strokeStyle=`rgba(0,0,0,${0.025*(1-d/110)})`; ctx.lineWidth=0.5;
          ctx.moveTo(particles[i].x,particles[i].y); ctx.lineTo(particles[j].x,particles[j].y); ctx.stroke(); }
      }
    }
    particles.forEach(p => {
      p.x+=p.vx; p.y+=p.vy; p.a+=p.da;
      if(p.x<0||p.x>W){p.vx*=-1; p.x=Math.max(0,Math.min(W,p.x));}
      if(p.y<0||p.y>H){p.vy*=-1; p.y=Math.max(0,Math.min(H,p.y));}
      if(p.a<0.05||p.a>0.95) p.da*=-1;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle=p.red?`rgba(232,19,42,${p.a*0.5})`:`rgba(0,0,0,${p.a*0.12})`; ctx.fill();
    });
    requestAnimationFrame(draw);
  }
  draw();
})();

// ─── SCROLL REVEAL ───
const revealObserver = new IntersectionObserver((entries) => {
  entries.forEach(e => { if(e.isIntersecting){e.target.classList.add('visible'); revealObserver.unobserve(e.target);} });
}, { threshold: 0.1, rootMargin: '0px 0px -40px 0px' });
document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));

// ═══════════════════════════════════════════════════════════════════
// GLOBAL APP STATE
// Do not prefill. All data arrives from API layer in Phase 4.
// ═══════════════════════════════════════════════════════════════════
const AppState = {
  user: null,         // { id, email, firstName, lastName, role, tier, paymentStatus, referralCode }
  profile: null,      // raw profile row (kept in sync with user, safe fallback)
  case: null,         // { id, caseNumber, permitType, permitTypeConfirmed, status, tier, reviewCyclesUsed, createdAt }
  questionnaire: null,// { completed, aiRecommendation, userSelectedType, specialistConfirmedType }
  documents: [],      // [{ id, documentType, fileName, status }]
  messages: [],       // [{ id, senderId, content, createdAt, isRead }]
  videoCall: null,    // { id, status, scheduledAt, durationMinutes, callType }
  loading: false,
  specialistCases: [],  // [{ id, status, created_at, user_id }]
  selectedCase: null    // selected case for detail view
};

// ─── SOFT PAYWALL HELPERS ───
function guardPremiumAction(actionFn) {
  if (!AppState.isPaidUser) {
    openUpgradeModal();
    return;
  }
  actionFn();
}

function openUpgradeModal() {
  document.getElementById('upgrade-modal').classList.add('open');
}

function closeUpgradeModal() {
  document.getElementById('upgrade-modal').classList.remove('open');
}

// ─── CANONICAL SYSTEM STATES ───
// Must match kartaflow-master-v1.2 exactly.
const SYSTEM_STATES = {
  UNAUTHENTICATED:       'unauthenticated',
  REGISTERED:            'registered',          // pending payment
  PAID:                  'paid',                // paid, questionnaire not started
  QUESTIONNAIRE_COMPLETE:'questionnaire_complete',
  CALL_CONFIRMED:        'call_confirmed',
  DOCUMENTS_PENDING:     'documents_pending',
  IN_REVIEW:             'in_review',
  APPROVED:              'approved',
  SUBMITTED:             'submitted',
  COMPLETED:             'completed'
};

// ─── SUPABASE CLIENT ───
const SUPABASE_URL      = "https://pthihpuebmmqiwwzbwvj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0aGlocHVlYm1tcWl3d3pid3ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNTcyNTUsImV4cCI6MjA4NzczMzI1NX0.xVP02tBUIFw4mPopdMSNNFI1yPd0DNBB4jeOgVTCgbo";
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ─── USER PROFILE MAPPER ───
// Maps public.users row to AppState.user shape expected by the router.
function _mapUserProfile(authUser, profile) {
  if (!profile) return null;
  const emailParts = (authUser.email || '').split('@')[0].split('.');
  return {
    id:            profile.id,
    email:         authUser.email,
    firstName:     profile.first_name || emailParts[0] || '',
    lastName:      profile.last_name  || emailParts[1] || '',
    role:          profile.role           || 'client',
    tier:          profile.tier           || null,
    paymentStatus: profile.payment_status || 'pending',
    referralCode:  profile.referral_code  || null,
  };
}

// ─── FETCH USER PROFILE ───
async function _fetchUserProfile(authUser) {
  try {
    const { data, error } = await _supabase
      .from('users')
      .select('*')
      .eq('id', authUser.id)
      .maybeSingle();
    if (error || !data) return null;
    return _mapUserProfile(authUser, data);
  } catch (_) { return null; }
}

// ─── FETCH CASE ───
async function _fetchCase(user) {
  if (!user) return null;
  try {
    if (user.role === 'client') {
      const { data, error } = await _supabase
        .from('cases')
        .select('*')
        .eq('user_id', user.id)
        .single();
      if (error || !data) return null;
      return data;
    }
    if (user.role === 'specialist') {
      const { data, error } = await _supabase
        .from('cases')
        .select('*')
        .eq('assigned_specialist_id', user.id);
      if (error || !data) return null;
      return data; // array for specialist
    }
    // admin — no auto-fetch
    return null;
  } catch (_) { return null; }
}

// ─── LOAD USER DATA ───
async function _loadUserData(authUser) {
  try {
    AppState.loading = true;
    renderApp();
    const profile = await _fetchUserProfile(authUser);
    if (!profile) {
      console.error('User profile not found or blocked by RLS — using safe fallback');
      // Build a minimal safe user from auth data so the app never gets stuck
      const emailParts = (authUser.email || '').split('@')[0].split('.');
      AppState.user = {
        id:            authUser.id,
        email:         authUser.email,
        firstName:     emailParts[0] || '',
        lastName:      emailParts[1] || '',
        role:          'client',
        tier:          null,
        paymentStatus: 'unpaid',
        referralCode:  null,
      };
    } else {
      AppState.user = profile;
      // Ensure paymentStatus is never null
      if (!AppState.user.paymentStatus) AppState.user.paymentStatus = 'unpaid';
    }
    AppState.isPaidUser = AppState.user.paymentStatus === 'paid';
    AppState.profile = AppState.user; // keep .profile in sync for safety
    AppState.case = await _fetchCase(AppState.user);
    AppState.loading = false;
    renderApp();
  } catch (err) {
    console.error('Fatal _loadUserData error:', err);
    AppState.loading = false;
    renderApp();
  }
}

// ─── AUTH INIT ───
async function initAuth() {
  // Subscribe to future auth changes (register once)
  _supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session) {
      await _loadUserData(session.user);
    }
    if (event === 'SIGNED_OUT') {
      AppState.user    = null;
      AppState.profile = null;
      AppState.case    = null;
      AppState.questionnaire = null;
      AppState.documents   = [];
      AppState.messages    = [];
      AppState.videoCall   = null;
      AppState.loading = false;
      renderApp();
    }
  });

  // Check for existing session (handles refresh / returning user)
  try {
    AppState.loading = true;
    renderApp();
    const { data: { session }, error: sessionError } = await _supabase.auth.getSession();

    if (sessionError) {
      console.error('Session error:', sessionError);
      AppState.user = null;
      AppState.profile = null;
      AppState.loading = false;
      renderApp();
      return;
    }

    if (!session) {
      AppState.user = null;
      AppState.profile = null;
      AppState.loading = false;
      renderApp();
      return;
    }

    // Session exists — load user data (onAuthStateChange SIGNED_IN may not fire on refresh)
    await _loadUserData(session.user);

  } catch (err) {
    console.error('Fatal initAuth error:', err);
    AppState.loading = false;
    renderApp();
  }
}

// ─── INITIALIZE APP ─── (alias used by DOMContentLoaded)
async function initializeApp() {
  await initAuth();
}

// ─── API LAYER (Supabase-backed) ───
const API = {
  login: async (email, password) => {
    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
    if (error || !data.user) return null;
    return data.user;
  },
  logout: async () => {
    await _supabase.auth.signOut();
  },
  fetchUser:           async () => AppState.user,
  fetchCase:           async () => AppState.case,
  fetchDocuments:      async () => Promise.resolve(null),
  fetchMessages:       async () => Promise.resolve(null),
  bookCall:            async (slotId)      => Promise.resolve(null),
  submitQuestionnaire: async (responses) => {
    // 1️⃣ State guard — abort silently if not in questionnaire_pending
    if (!AppState.case || AppState.case.status !== 'questionnaire_pending') {
      await refreshCase();
      renderApp();
      return null;
    }
    const caseId = AppState.case.id;
    if (!caseId) return null;
    // 2️⃣ Insert questionnaire response row, capturing returned data
    const { data, error: insertError } = await _supabase
      .from('questionnaire_responses')
      .insert({
        case_id: caseId,
        responses: responses
      })
      .select()
      .single();
    // 3️⃣ Handle errors: treat duplicate (23505) as success; sign out only on auth/session errors
    if (insertError) {
      if (insertError.code === '23505') {
        // Duplicate — treat as success, continue to RPC
      } else {
        const isAuthError = insertError.status === 401 || insertError.status === 403 ||
          (insertError.message && (
            insertError.message.toLowerCase().includes('jwt') ||
            insertError.message.toLowerCase().includes('auth') ||
            insertError.message.toLowerCase().includes('session')
          ));
        if (isAuthError) {
          await _supabase.auth.signOut();
        }
        return null;
      }
    }
    // 4️⃣ Update case status via RPC (awaited)
    const { error: rpcError } = await _supabase.rpc('update_case_status', {
      p_case_id: caseId,
      p_new_status: 'questionnaire_complete'
    });
    if (rpcError) {
      const isPermissionError = rpcError.status === 401 || rpcError.status === 403 ||
        (rpcError.message && (
          rpcError.message.toLowerCase().includes('permission') ||
          rpcError.message.toLowerCase().includes('jwt') ||
          rpcError.message.toLowerCase().includes('auth')
        ));
      if (isPermissionError) {
        await _supabase.auth.signOut();
      }
      return null;
    }
    return true;
  }
};

// ─── ROUTE GUARD ───
function canAccessRoute(routeName) {
  const { user, case: userCase, questionnaire, videoCall } = AppState;

  // Unauthenticated — only landing and auth
  if (!user) return routeName === 'auth' || routeName === 'landing';

  const role = user.role;
  const paymentStatus = user.paymentStatus;

  // Role-locked routes
  if (role === 'specialist') return routeName === 'specialist';
  if (role === 'admin')      return routeName === 'admin';

  // Client gate: payment required — REMOVED (soft paywall via guardPremiumAction)
  // Unpaid users can access questionnaire and dashboard; premium actions are gated individually.

  // Client gate: questionnaire required
  if (!questionnaire || !questionnaire.completed) return routeName === 'questionnaire';

  // Client gate: confirmation call required (paid users only)
  if (AppState.isPaidUser && (!videoCall || videoCall.status !== 'completed')) return routeName === 'book-call';

  // Full client dashboard (also accessible to unpaid users after questionnaire)
  return routeName === 'client' || routeName === 'questionnaire';
}

// ─── SAFE PAGE ACTIVATION HELPER ───
function safeActivatePage(pageId) {
  try {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    const page = document.getElementById(pageId);
    if (page) {
      page.classList.add("active");
    } else {
      console.error("Missing page:", pageId);
      const fallback = document.getElementById("page-landing");
      if (fallback) fallback.classList.add("active");
    }
  } catch (err) {
    console.error("Page activation failed:", err);
  }
}

// ─── DETERMINISTIC ROUTER ───
// Single source of truth. Derives screen from AppState.
// No direct page mutations outside this function.
function renderApp() {
  try {
    if (AppState.loading) {
      safeActivatePage("page-landing");
      return;
    }

    if (!AppState.user) {
      safeActivatePage("page-landing");
      return;
    }

    const paymentStatus = AppState.profile?.payment_status || "unpaid";

    const { user, case: userCase, questionnaire, videoCall } = AppState;

    // ── Role-based routing ──
    document.getElementById('main-nav').style.display = 'none';

    if (user.role === 'specialist' || user.role === 'admin') {
      safeActivatePage("page-specialist");
      renderSpecialistPage();
      return;
    }

    if (user.role === 'admin_legacy') {
      safeActivatePage("page-admin");
      renderAdminDashboard('dashboard');
      return;
    }

    // ── Client state machine ──

    // Gate 1 (REMOVED): unpaid users are no longer hard-redirected to page-plan-selection.
    // Soft paywall is enforced per-action via guardPremiumAction().

    // Gate 2: questionnaire — must complete before reaching dashboard
    if (!questionnaire || !questionnaire.completed) {
      safeActivatePage("page-questionnaire");
      return;
    }

    // Gate 3: confirmation call — only block if user is paid AND call not completed
    if (AppState.isPaidUser && (!videoCall || videoCall.status !== 'completed')) {
      safeActivatePage("page-book-call");
      return;
    }

    // Gate 4: case-status-driven dashboard view
    safeActivatePage("page-client");
    _hydrateClientSidebar();

    const status = userCase ? userCase.status : null;
    switch (status) {
      case 'questionnaire_pending':
      case 'questionnaire_complete':
        renderClientDashboard('overview');
        break;
      case 'call_pending':
        renderClientDashboard(AppState.isPaidUser ? 'booking' : 'overview');
        break;
      case 'call_confirmed':
      case 'documents_pending':
      case 'ai_checking':
      case 'needs_revision':
        renderClientDashboard('documents');
        break;
      case 'in_review':
      case 'approved':
      case 'submitted':
      case 'completed':
        renderClientDashboard('overview');
        break;
      default:
        renderClientDashboard('overview');
    }
  } catch (err) {
    console.error("Render crash:", err);
    safeActivatePage("page-landing");
  }
}

// ─── LOW-LEVEL PAGE SWITCHER ───
// Only called from renderApp(). Do not call directly for navigation.
function _showRawPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if (el) el.classList.add('active');
  window.scrollTo(0, 0);
  setTimeout(() => lucide.createIcons(), 50);
}

// ─── SIDEBAR HYDRATION ───
function _hydrateClientSidebar() {
  const u = AppState.user;
  if (!u) return;
  const nameEl   = document.getElementById('client-name');
  const avatarEl = document.getElementById('client-avatar');
  const tierEl   = document.getElementById('client-tier-label');
  if (nameEl)   nameEl.textContent   = (u.firstName || '') + ' ' + (u.lastName || '');
  if (avatarEl) avatarEl.textContent = ((u.firstName||'?')[0] + (u.lastName||'?')[0]).toUpperCase();
  if (tierEl)   tierEl.textContent   = 'Client · ' + _tierLabel(u.tier);
}

function _hydrateSpecialistSidebar() {
  const u = AppState.user;
  if (!u) return;
  const nameEl = document.getElementById('specialist-name');
  if (nameEl) nameEl.textContent = (u.firstName || '') + ' ' + (u.lastName || '');
}

// ─── LANDING / PUBLIC NAV HELPERS ───
function goToLanding() {
  if (AppState.user) { renderApp(); return; }
  document.getElementById('main-nav').style.display = 'flex';
  _showRawPage('landing');
}

function showAuthPage(tab) {
  if (AppState.user) { renderApp(); return; }
  document.getElementById('main-nav').style.display = 'flex';
  _showRawPage('auth');
  switchAuthTab(tab || 'login');
  setTimeout(() => lucide.createIcons(), 50);
}

function scrollToSection(id) {
  if (AppState.user) return;
  document.getElementById('main-nav').style.display = 'flex';
  _showRawPage('landing');
  setTimeout(() => {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 50);
}

function selectTier(tier) {
  showAuthPage('register');
  showToast(tier.replace('tier','Tier ') + ' selected — create your account', 'success');
}

// ─── MOBILE MENU ───
function openMobileMenu() { document.getElementById('mobile-menu').classList.add('open'); lucide.createIcons(); }
function closeMobileMenu(e) { if(e.target===document.getElementById('mobile-menu')) closeMobileMenuDirect(); }
function closeMobileMenuDirect() { document.getElementById('mobile-menu').classList.remove('open'); }

// ─── AUTH ───
function switchAuthTab(tab, btn) {
  document.getElementById('auth-login').style.display    = tab==='login' ? 'block' : 'none';
  document.getElementById('auth-register').style.display = tab==='register' ? 'block' : 'none';
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  const t = document.getElementById(tab==='login' ? 'tab-login' : 'tab-register');
  if (t) t.classList.add('active');
}

async function handleLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value;
  if (!email || !pass) { showToast('Please enter your email and password', 'error'); return; }
  showToast('Signing in…', 'info');
  AppState.loading = true;
  renderApp();
  const { data, error } = await _supabase.auth.signInWithPassword({ email, password: pass });
  if (error || !data.user) {
    AppState.loading = false;
    renderApp();
    showToast('Invalid email or password. Please try again.', 'error');
    return;
  }
  // onAuthStateChange will handle the rest
}

async function handleRegister() {
  const first = document.getElementById('reg-first').value.trim();
  const last  = document.getElementById('reg-last').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass  = document.getElementById('reg-password').value;
  if (!first || !last || !email || !pass) { showToast('Please fill in all required fields', 'error'); return; }
  if (pass.length < 8) { showToast('Password must be at least 8 characters', 'error'); return; }
  AppState.loading = true;
  renderApp();
  const { data, error } = await _supabase.auth.signUp({
    email,
    password: pass,
    options: { data: { first_name: first, last_name: last } }
  });
  if (error) {
    AppState.loading = false;
    renderApp();
    showToast(error.message || 'Registration failed. Please try again.', 'error');
    return;
  }
  if (data.user && !data.session) {
    // Email confirmation required
    AppState.loading = false;
    renderApp();
    showToast('Account created — please check your email to confirm your address.', 'success');
    return;
  }
  // onAuthStateChange handles the rest if auto-confirmed
}

async function handleLogout() {
  await _supabase.auth.signOut();
  // onAuthStateChange SIGNED_OUT will clear AppState and call renderApp()
  showToast('Signed out successfully', 'success');
}

// ─── QUESTIONNAIRE SUBMIT ───
async function handleQuestionnaireSubmit() {
  // 1️⃣ Client-side state guard
  if (!AppState.case || AppState.case.status !== 'questionnaire_pending') return;

  const fields = {
    primary_reason:     document.getElementById('q_primary_reason')?.value    || '',
    nationality:        document.getElementById('q_nationality')?.value        || '',
    work_permit:        document.getElementById('q_work_permit')?.value        || '',
    residence_duration: document.getElementById('q_residence_duration')?.value || '',
    entry_basis:        document.getElementById('q_entry_basis')?.value        || '',
    family_ties:        document.getElementById('q_family_ties')?.value        || '',
    student_status:     document.getElementById('q_student_status')?.value     || '',
    voivodeship:        document.getElementById('q_voivodeship')?.value        || '',
    previous_rejection: document.getElementById('q_previous_rejection')?.value || '',
    additional_info:    document.getElementById('q_additional_info')?.value    || ''
  };
  const required = ['primary_reason','nationality','work_permit','residence_duration',
                    'entry_basis','family_ties','student_status','voivodeship','previous_rejection'];
  for (const key of required) {
    if (!fields[key]) {
      showToast('Please answer all required questions.', 'error');
      return;
    }
  }
  const btn = document.getElementById('questionnaire-submit-btn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2"></i> Submitting…'; lucide.createIcons(); }

  // Compute client-side TRC recommendation based on responses
  function _computeTrcRecommendation(f) {
    if (f.student_status === 'yes_full_time' || f.student_status === 'yes_phd') return 'TRC for Study (Nauka)';
    if (f.family_ties === 'yes_spouse_polish') return 'TRC for Family Reunification (Rodzina)';
    if (f.primary_reason === 'family_reunion') return 'TRC for Family Reunification (Rodzina)';
    if (f.primary_reason === 'work_b2b') return 'TRC for Self-Employment (Działalność)';
    if (f.primary_reason === 'work_employment') return 'TRC for Employment (Praca)';
    return 'TRC — Temporary Residence';
  }
  const trcRecommendation = _computeTrcRecommendation(fields);

  try {
    // Allow re-editing: if case is already questionnaire_complete, skip API call and just update locally
    const caseStatus = AppState.case ? AppState.case.status : null;
    if (caseStatus === 'questionnaire_complete' || caseStatus === 'call_pending' ||
        caseStatus === 'call_confirmed' || caseStatus === 'documents_pending') {
      // Re-edit mode: save locally, no DB re-insert needed
      AppState.questionnaire = { completed: true, aiRecommendation: trcRecommendation };
      showToast('Questionnaire updated.', 'success');
      renderApp();
      return;
    }
    const result = await API.submitQuestionnaire(fields);
    if (!result) throw new Error('submit_failed');
    // Re-fetch case after submission
    AppState.case = await _fetchCase(AppState.user);
    AppState.questionnaire = { completed: true, aiRecommendation: trcRecommendation };
    showToast('Questionnaire submitted! Here is your suggested TRC type.', 'success');
    renderApp();
  } catch (err) {
    // Re-enable submit button on non-auth errors; skip if user was signed out
    if (!AppState.user) return; // auth sign-out in progress; do not re-enable
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="send"></i> Submit questionnaire'; lucide.createIcons(); }
    showToast('Submission failed. Please try again.', 'error');
  }
}

// ─── CLIENT DASHBOARD ───
function clientNav(section, btn) {
  document.querySelectorAll('#page-client .dash-nav-item').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderClientSection(section);
}

function openEditQuestionnaire() {
  safeActivatePage('page-questionnaire');
  // Show back button since user is editing from dashboard
  const backWrap = document.getElementById('questionnaire-back-btn-wrap');
  if (backWrap) backWrap.style.display = 'block';
  const modeLabel = document.getElementById('questionnaire-mode-label');
  if (modeLabel && AppState.questionnaire && AppState.questionnaire.completed) {
    modeLabel.textContent = 'Edit your TRC questionnaire';
  }
  lucide.createIcons();
}

function renderClientDashboard(section) { renderClientSection(section || 'overview'); }

function renderClientSection(section) {
  const main = document.getElementById('client-main');
  if (!main) return;
  const renders = {
    overview:  renderClientOverview,
    intake:    renderClientIntake,
    documents: renderClientDocuments,
    messages:  renderClientMessages,
    booking:   renderClientBooking,
    billing:   renderClientBilling,
    family:    renderClientFamily,
    referral:  renderClientReferral,
  };
  main.innerHTML = (renders[section] || renders.overview)();
  lucide.createIcons();
}

// ─── CLIENT OVERVIEW ───
function renderClientOverview() {
  const u  = AppState.user;
  const c  = AppState.case;
  const docs = AppState.documents;

  const firstName = u ? u.firstName : '';
  const caseType  = c && c.permitType ? c.permitType : '—';
  const caseNum   = c ? c.caseNumber : '—';
  const tierLabel = u && u.tier ? 'Tier ' + u.tier.replace('tier','') : '—';
  const status    = c ? c.status : null;
  const statusLabel = _mapStatusLabel(status);
  const badgeClass  = _mapStatusBadge(status);

  const docsTotal    = docs.length;
  const docsVerified = docs.filter(d => d.status === 'verified').length;
  const cyclesMax    = _getTierFeature(u ? u.tier : null, 'review_cycles_max');
  const cyclesUsed   = c ? (c.reviewCyclesUsed || 0) : 0;
  const msgs         = AppState.messages;
  const unread       = msgs.filter(m => !m.isRead).length;
  const daysSince    = c && c.createdAt ? Math.floor((Date.now()-new Date(c.createdAt))/86400000) : null;

  return `
    <div class="dash-topbar">
      <div>
        <div class="dash-page-title">Welcome back${firstName ? ', '+firstName : ''}</div>
        <div class="dash-page-sub">${caseType} · Case ${caseNum} · ${tierLabel}</div>
      </div>
      <span class="badge ${badgeClass}"><i data-lucide="clock" style="width:11px;height:11px"></i> ${statusLabel}</span>
    </div>

    ${AppState.questionnaire && AppState.questionnaire.aiRecommendation ? `
    <div class="card" style="margin-bottom:16px;border:1px solid rgba(22,163,74,0.25);background:rgba(22,163,74,0.04)">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:36px;height:36px;border-radius:50%;background:rgba(22,163,74,0.1);display:flex;align-items:center;justify-content:center;flex-shrink:0">
            <i data-lucide="check-circle" style="width:18px;height:18px;color:#16A34A"></i>
          </div>
          <div>
            <div style="font-size:12px;font-weight:600;color:#16A34A;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:2px">Suggested TRC Application</div>
            <div style="font-size:16px;font-weight:700;color:var(--text)">${AppState.questionnaire.aiRecommendation}</div>
            <div style="font-size:12px;color:var(--text-3);margin-top:2px">Based on your questionnaire — your specialist will confirm</div>
          </div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="openEditQuestionnaire()" style="white-space:nowrap">
          <i data-lucide="edit-3"></i> Edit questionnaire
        </button>
      </div>
    </div>` : `
    <div class="card" style="margin-bottom:16px;border:1px solid rgba(232,19,42,0.2);background:rgba(232,19,42,0.03)">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
        <div>
          <div style="font-size:14px;font-weight:600;margin-bottom:2px">Complete your questionnaire</div>
          <div style="font-size:13px;color:var(--text-2)">Help us determine the right TRC type for your situation.</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openEditQuestionnaire()">
          <i data-lucide="clipboard-list"></i> Start questionnaire
        </button>
      </div>
    </div>`}

    ${!AppState.isPaidUser ? `
    <div class="card" style="margin-bottom:20px;border:1px solid rgba(232,19,42,0.25);background:rgba(232,19,42,0.04)">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
        <div>
          <div style="font-weight:700;font-size:15px;margin-bottom:4px">
            Unlock your full application support
          </div>
          <div style="font-size:13px;color:var(--text-2)">
            Upgrade to activate document uploads, lawyer review, and submission.
          </div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openUpgradeModal()">
          Upgrade now
        </button>
      </div>
    </div>
    ` : ''}

    <div class="stats-grid" style="margin-bottom:20px">
      <div class="stat-card">
        <div class="stat-label">Documents</div>
        <div class="stat-value">${docsTotal ? docsVerified+'/'+docsTotal : '—'}</div>
        <div class="stat-change" style="color:var(--text-3)">${docsTotal ? (docsTotal-docsVerified)+' remaining' : 'Pending checklist'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Review cycles</div>
        <div class="stat-value">${cyclesMax !== null ? cyclesUsed+'/'+(cyclesMax===-1?'∞':cyclesMax) : '—'}</div>
        <div class="stat-change" style="color:var(--text-3)">${cyclesMax===-1?'Unlimited':cyclesMax!==null?(cyclesMax-cyclesUsed)+' left':'—'}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Days since start</div>
        <div class="stat-value">${daysSince !== null ? daysSince : '—'}</div>
        <div class="stat-change" style="color:var(--text-3)">Avg: 18 days total</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Messages</div>
        <div class="stat-value">${msgs.length || '—'}</div>
        <div class="stat-change" style="color:${unread?'var(--red)':'var(--text-3)'}">${unread ? unread+' unread' : 'No unread'}</div>
      </div>
    </div>

    ${status === 'questionnaire_complete' ? `
    <div class="card" style="margin-bottom:16px;max-width:540px">
      <div style="font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px">
        <i data-lucide="video" style="width:17px;height:17px;color:var(--red)"></i> Schedule Your Consultation
      </div>
      <div class="form-group">
        <label class="form-label" for="vc-datetime">Select date &amp; time</label>
        <input type="datetime-local" id="vc-datetime" class="form-input">
      </div>
      <button class="btn btn-primary" id="vc-book-btn" onclick="guardPremiumAction(handleBookVideoCall)">
        <i data-lucide="calendar"></i> Book Consultation
      </button>
    </div>` : ''}

    ${status === 'call_confirmed' && docsTotal > 0 ? `
    <div class="card" style="margin-bottom:16px;max-width:540px">
      <div style="font-size:16px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px">
        <i data-lucide="send" style="width:17px;height:17px;color:var(--red)"></i> Submit Your Case
      </div>
      <div style="font-size:13px;color:var(--text-2);margin-bottom:18px">Once submitted, your specialist will begin full review.</div>
      <button class="btn btn-primary" id="submit-review-btn" onclick="guardPremiumAction(submitCaseForReview)">
        <i data-lucide="send"></i> Submit for Review
      </button>
    </div>` : ''}

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div style="font-size:14px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px">
          <i data-lucide="activity" style="width:16px;height:16px;color:var(--red)"></i> Application progress
        </div>
        ${_renderProgressSteps(status)}
      </div>
      <div class="card">
        <div style="font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px">
          <i data-lucide="info" style="width:16px;height:16px;color:var(--text-3)"></i> Current status
        </div>
        <div style="background:var(--surface);border-radius:12px;padding:16px;font-size:13px;color:var(--text-2);line-height:1.65">
          ${_renderStatusMessage(status)}
        </div>
      </div>
    </div>
  `;
}

async function submitCaseForReview() {
  const btn = document.getElementById('submit-review-btn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader" style="width:16px;height:16px"></i> Submitting…'; lucide.createIcons(); }
  try {
    const { data, error } = await supabase.rpc('submit_case_for_review', { p_case_id: AppState.case.id });
    if (error) {
      if (error.message && error.message.toLowerCase().includes('auth')) {
        await supabase.auth.signOut();
        return;
      }
      throw error;
    }
    await refreshCase();
    renderApp();
    showToast('Case submitted for review!', 'success');
  } catch (e) {
    showToast('Unable to submit. Please try again.', 'error');
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="send" style="width:16px;height:16px"></i> Submit for Review'; lucide.createIcons(); }
  }
}

// ─── RESUBMIT FOR REVIEW (needs_revision) ───
async function resubmitCaseForReview() {
  const btn = document.getElementById('resubmit-review-btn');
  if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader" style="width:16px;height:16px"></i> Submitting…'; lucide.createIcons(); }
  try {
    const { data, error } = await supabase.rpc('submit_case_for_review', { p_case_id: AppState.case.id });
    if (error) {
      const isAuthError = error.status === 401 || error.status === 403 ||
        (error.message && (
          error.message.toLowerCase().includes('auth') ||
          error.message.toLowerCase().includes('jwt') ||
          error.message.toLowerCase().includes('permission')
        ));
      if (isAuthError) {
        await supabase.auth.signOut();
        return;
      }
      if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="send" style="width:16px;height:16px"></i> Resubmit for Review'; lucide.createIcons(); }
      showToast('Unable to resubmit. Please try again.', 'error');
      return;
    }
    await refreshCase();
    renderApp();
    showToast('Case resubmitted for review!', 'success');
  } catch (e) {
    if (!AppState.user) return;
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="send" style="width:16px;height:16px"></i> Resubmit for Review'; lucide.createIcons(); }
    showToast('Unable to resubmit. Please try again.', 'error');
  }
}

function _renderProgressSteps(status) {
  const steps = [
    {label:'Payment',       icon:'credit-card'},
    {label:'Questionnaire', icon:'clipboard-list'},
    {label:'Confirm Call',  icon:'video'},
    {label:'Documents',     icon:'upload-cloud'},
    {label:'Review',        icon:'scale'},
    {label:'Approval',      icon:'check-circle'},
    {label:'Submit',        icon:'send'},
  ];
  const idx = {
    questionnaire_pending:0, questionnaire_complete:1, call_pending:2,
    call_confirmed:3, documents_pending:3, ai_checking:3, needs_revision:3,
    in_review:4, approved:5, submitted:6, completed:6
  };
  const cur = idx[status] !== undefined ? idx[status] : 0;
  return `<div class="progress-steps">` + steps.map((s,i) => {
    const done = i < cur, active = i === cur;
    return `<div class="progress-step${done?' done':active?' active':''}">
      <div class="ps-dot">${done ? '<i data-lucide="check" style="width:12px;height:12px"></i>' : `<i data-lucide="${s.icon}" style="width:12px;height:12px"></i>`}</div>
      <div class="ps-label">${s.label}</div>
    </div>`;
  }).join('') + '</div>';
}

function _renderStatusMessage(status) {
  const map = {
    questionnaire_pending: 'Complete the TRC Type Questionnaire to determine your permit type.',
    questionnaire_complete:'Book your confirmation call to verify your TRC type with the specialist.',
    call_pending:          'Your confirmation call is scheduled. You will receive a reminder.',
    call_confirmed:        'Your TRC type is confirmed. Begin uploading required documents.',
    documents_pending:     'Upload all required documents to begin specialist review.',
    ai_checking:           'Documents are being validated by the AI pre-check system.',
    needs_revision:        'Some documents require revision. Check the Documents section.',
    in_review:             'Your specialist is reviewing your documents.',
    approved:              'All documents approved. Ready to submit to the Voivodeship office.',
    submitted:             'Application has been submitted to the Voivodeship office.',
    completed:             'Your case is complete.',
  };
  return map[status] || 'Loading your case information…';
}

function _mapStatusLabel(status) {
  const m = {
    questionnaire_pending:'Questionnaire', questionnaire_complete:'Call Pending',
    call_pending:'Call Pending', call_confirmed:'Documents',
    documents_pending:'Documents', ai_checking:'AI Checking',
    needs_revision:'Needs Revision', in_review:'In Review',
    approved:'Approved', submitted:'Submitted', completed:'Completed'
  };
  return m[status] || 'Loading';
}

function _mapStatusBadge(status) {
  if (!status) return 'badge-grey';
  if (['in_review','ai_checking','call_pending','call_confirmed'].includes(status)) return 'badge-amber';
  if (['needs_revision'].includes(status)) return 'badge-red';
  if (['approved','completed'].includes(status)) return 'badge-green';
  return 'badge-grey';
}

function _getTierFeature(tier, feature) {
  const m = { tier1:{review_cycles_max:1}, tier2:{review_cycles_max:5}, tier3:{review_cycles_max:-1} };
  return m[tier] ? m[tier][feature] : null;
}

// ─── CLIENT DOCUMENTS ───
function renderClientDocuments() {
  const docs      = AppState.documents;
  const cStatus   = AppState.case ? AppState.case.status : null;
  const canUpload = ['call_confirmed','documents_pending','ai_checking','needs_revision','in_review'].includes(cStatus);

  const revisionCard = cStatus === 'needs_revision' ? `
    <div class="card" style="margin-bottom:16px;max-width:620px;border-color:var(--red-border)">
      <div style="display:flex;align-items:flex-start;gap:14px">
        <div style="flex:1">
          <div style="margin-bottom:10px"><span class="badge badge-red"><i data-lucide="alert-circle" style="width:11px;height:11px"></i> Action Required</span></div>
          <div style="font-size:16px;font-weight:700;margin-bottom:8px;letter-spacing:-0.01em">Revisions Required</div>
          <div style="font-size:13px;color:var(--text-2);line-height:1.65;margin-bottom:18px">Your specialist has requested updates to your documents. Please review their feedback, upload revised files, and resubmit your case.</div>
          <button class="btn btn-primary" id="resubmit-review-btn" onclick="resubmitCaseForReview()">
            <i data-lucide="send"></i> Resubmit for Review
          </button>
        </div>
      </div>
    </div>` : '';

  if (!docs.length) return `
    <div class="dash-topbar">
      <div><div class="dash-page-title">My Documents</div>
        <div class="dash-page-sub">No documents yet</div></div>
      ${canUpload ? '<button class="btn btn-primary btn-sm" onclick="guardPremiumAction(openUploadModal)"><i data-lucide="upload-cloud"></i> Upload document</button>' : ''}
    </div>
    ${revisionCard}
    <div class="card" style="text-align:center;padding:48px 24px">
      <i data-lucide="folder-open" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">No documents uploaded yet</div>
      <div style="font-size:13px;color:var(--text-4);margin-top:6px">Your personalised document checklist will appear here after your confirmation call.</div>
    </div>`;

  const verified = docs.filter(d => d.status === 'verified');
  const pending  = docs.filter(d => d.status !== 'verified');
  return `
    <div class="dash-topbar">
      <div><div class="dash-page-title">My Documents</div>
        <div class="dash-page-sub">${verified.length} of ${docs.length} documents verified</div></div>
      ${canUpload ? '<button class="btn btn-primary btn-sm" onclick="guardPremiumAction(openUploadModal)"><i data-lucide="upload-cloud"></i> Upload document</button>' : ''}
    </div>
    ${revisionCard}
    ${verified.length ? `<div class="card" style="margin-bottom:16px">
      <div style="font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <i data-lucide="list-checks" style="width:15px;height:15px;color:var(--success)"></i> Verified</div>
      <table class="data-table"><thead><tr><th>Document</th><th>Status</th><th>Actions</th></tr></thead><tbody>
        ${verified.map(d=>`<tr>
          <td style="font-weight:600;font-size:13px">${d.fileName||d.documentType}</td>
          <td><span class="badge badge-green"><i data-lucide="check" style="width:11px;height:11px"></i> Verified</span></td>
          <td><button class="btn btn-ghost btn-sm"><i data-lucide="eye"></i></button></td>
        </tr>`).join('')}
      </tbody></table></div>` : ''}
    ${pending.length ? `<div class="card">
      <div style="font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px">
        <i data-lucide="alert-circle" style="width:15px;height:15px;color:var(--red)"></i> Pending</div>
      <table class="data-table"><thead><tr><th>Document</th><th>Status</th><th>Action</th></tr></thead><tbody>
        ${pending.map(d=>`<tr>
          <td style="font-weight:600;font-size:13px">${d.fileName||d.documentType}</td>
          <td><span class="badge badge-amber">${d.status}</span></td>
          <td>${canUpload?'<button class="btn btn-primary btn-sm"><i data-lucide="upload"></i> Upload</button>':'—'}</td>
        </tr>`).join('')}
      </tbody></table></div>` : ''}`;
}

// ─── CLIENT MESSAGES ───
function renderClientMessages() {
  const u = AppState.user;
  const canMsg = u && (u.tier==='tier2'||u.tier==='tier3');
  if (!canMsg) return `
    <div class="dash-topbar"><div class="dash-page-title">Messages</div></div>
    <div class="card" style="max-width:680px">
      <div style="background:var(--surface);border-radius:12px;padding:24px;text-align:center">
        <i data-lucide="lock" style="width:32px;height:32px;color:var(--text-4);margin:0 auto 12px;display:block"></i>
        <div style="font-size:14px;font-weight:700;margin-bottom:6px">Messaging available on Tier 2 and Tier 3</div>
        <div style="font-size:13px;color:var(--text-3)">Upgrade your plan to unlock direct messaging with your specialist.</div>
        <button class="btn btn-primary" style="margin-top:16px" onclick="clientNav('billing')">Upgrade plan</button>
      </div></div>`;

  const msgs = AppState.messages;
  return `
    <div class="dash-topbar"><div class="dash-page-title">Messages</div></div>
    <div class="card" style="max-width:680px">
      ${msgs.length ? `<div style="display:flex;flex-direction:column;gap:14px;margin-bottom:20px;max-height:380px;overflow-y:auto">
        ${msgs.map(m=>{
          const mine = AppState.user && m.senderId===AppState.user.id;
          return `<div style="background:${mine?'var(--red-soft);border:1px solid var(--red-border)':'var(--surface)'};border-radius:12px;padding:14px;max-width:85%;${mine?'align-self:flex-end':''}">
            <div style="font-size:12px;color:var(--text-3);margin-bottom:6px;${mine?'text-align:right':''}">${mine?'You':'Specialist'} · ${m.createdAt||''}</div>
            <div style="font-size:14px;line-height:1.65">${m.content}</div>
          </div>`;
        }).join('')}
      </div>` : `<div style="font-size:13px;color:var(--text-3);padding:32px;text-align:center">No messages yet. Your specialist will contact you here.</div>`}
      <div style="display:flex;gap:10px">
        <input type="text" class="form-input" placeholder="Write a message…" id="msg-input" style="flex:1">
        <button class="btn btn-primary" onclick="guardPremiumAction(sendMessage)"><i data-lucide="send"></i></button>
      </div>
    </div>`;
}

function sendMessage() {
  const input = document.getElementById('msg-input');
  if (!input||!input.value.trim()) return;
  showToast('Messaging available once backend is connected.','info');
  input.value = '';
}

// ─── VIDEO CALL BOOKING ───
async function handleBookVideoCall() {
  const input = document.getElementById('vc-datetime');
  const btn   = document.getElementById('vc-book-btn');
  if (!input || !input.value) { showToast('Please select a date and time.', 'error'); return; }
  const isoDate = new Date(input.value).toISOString();
  if (!AppState.case || !AppState.case.id) { showToast('Unable to find your case. Please refresh.', 'error'); return; }
  if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2"></i> Booking…'; lucide.createIcons(); }
  try {
    const { error } = await _supabase.rpc('book_video_call', {
      p_case_id:          AppState.case.id,
      p_scheduled_at:     isoDate,
      p_duration_minutes: 30
    });
    if (error) throw error;
    await refreshCase();
    renderApp();
    showToast('Consultation booked successfully!', 'success');
  } catch (err) {
    if (!AppState.user) return;
    if (err && (err.code === 'PGRST301' || (err.message && err.message.toLowerCase().includes('auth')))) {
      await _supabase.auth.signOut();
      return;
    }
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="calendar"></i> Book Consultation'; lucide.createIcons(); }
    showToast('Booking failed. Please try again.', 'error');
  }
}

// ─── CLIENT INTAKE ───
function renderClientIntake() {
  return `
    <div class="dash-topbar"><div class="dash-page-title">Intake Form</div></div>
    <div class="card" style="max-width:580px">
      <div style="font-size:15px;font-weight:700;margin-bottom:4px">Your application details</div>
      <div style="font-size:13px;color:var(--text-3);margin-bottom:24px">This helps us build your personalised document checklist.</div>
      <div class="form-group"><label class="form-label">Permit type</label>
        <select class="form-select">
          <option>Work TRC (Employment)</option><option>Work TRC (Business owner)</option>
          <option>Family TRC</option><option>Student TRC</option><option>Long-term Resident TRC</option>
        </select></div>
      <div class="form-group"><label class="form-label">Which Voivodeship (city office)?</label>
        <select class="form-select">
          <option>Warsaw (Mazowieckie)</option><option>Kraków (Małopolskie)</option>
          <option>Wrocław (Dolnośląskie)</option><option>Poznań (Wielkopolskie)</option>
          <option>Gdańsk (Pomorskie)</option><option>Other</option>
        </select></div>
      <div class="form-group"><label class="form-label">Nationality</label>
        <input type="text" class="form-input" placeholder="Your nationality"></div>
      <div class="form-group"><label class="form-label">Current visa type</label>
        <select class="form-select">
          <option>National D visa (work)</option><option>Schengen C visa</option>
          <option>Temporary residence permit</option><option>Visa-free entry</option>
        </select></div>
      <button class="btn btn-primary" onclick="showToast('Intake form available once backend is connected.','info')">
        <i data-lucide="save"></i> Save & update checklist
      </button>
    </div>`;
}

// ─── CLIENT BOOKING ───
function renderClientBooking() {
  const u    = AppState.user;
  const call = AppState.videoCall;
  if (!u) return '<div class="dash-topbar"><div class="dash-page-title">Book a Call</div></div>';
  const mins  = {tier1:15,tier2:30,tier3:null}[u.tier];
  const durLabel = mins ? mins+'-minute' : 'Unlimited';
  return `
    <div class="dash-topbar"><div class="dash-page-title">Book a Confirmation Call</div></div>
    <div class="card" style="max-width:540px">
      <div style="background:var(--surface);border-radius:12px;padding:16px;margin-bottom:20px">
        <div style="font-size:13px;font-weight:700;margin-bottom:4px">Your included call: ${durLabel} confirmation call</div>
        <div style="font-size:13px;color:var(--text-3)">Verify your TRC type with a licensed specialist before uploading documents.</div>
      </div>
      ${call && call.status==='scheduled' ? `
        <div style="background:rgba(22,163,74,0.08);border:1px solid rgba(22,163,74,0.2);border-radius:12px;padding:16px;margin-bottom:16px">
          <div style="font-size:14px;font-weight:700;color:var(--success)">Call scheduled</div>
          <div style="font-size:13px;color:var(--text-2);margin-top:4px">${call.scheduledAt||'—'}</div>
        </div>` : `
        <div style="background:var(--surface);border-radius:12px;padding:24px;text-align:center;margin-bottom:16px">
          <i data-lucide="calendar" style="width:40px;height:40px;color:var(--text-4);margin:0 auto 12px;display:block"></i>
          <div style="font-size:14px;font-weight:600;color:var(--text-3)">Calendar booking will be available once backend is connected.</div>
        </div>
        <button class="btn btn-primary btn-full" onclick="showToast('Call booking available once backend is connected.','info')">
          <i data-lucide="calendar"></i> Book my confirmation call
        </button>`}
    </div>`;
}

// ─── CLIENT BILLING ───
function renderClientBilling() {
  const u = AppState.user;
  return `
    <div class="dash-topbar"><div class="dash-page-title">Billing</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card">
        <div style="font-size:14px;font-weight:700;margin-bottom:16px">Current plan</div>
        ${u && u.tier ? `
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
            <div style="width:48px;height:48px;border-radius:14px;background:var(--dark);display:flex;align-items:center;justify-content:center;color:white">
              <i data-lucide="zap" style="width:20px;height:20px"></i></div>
            <div>
              <div style="font-family:var(--font-display);font-size:18px;font-weight:700">${_tierLabel(u.tier)}</div>
              <div style="font-size:13px;color:var(--text-3)">${_tierPrice(u.tier)} · one-time payment</div>
            </div></div>
          <div style="font-size:13px;color:var(--text-2);margin-bottom:16px;line-height:1.65">${_tierFeaturesSummary(u.tier)}</div>
          ${u.tier!=='tier3'?`<button class="btn btn-outline btn-full" onclick="showToast('Upgrade available once backend is connected.','info')"><i data-lucide="arrow-up-circle"></i> Upgrade plan</button>`:''}
        ` : '<div style="font-size:13px;color:var(--text-3)">Loading plan…</div>'}
      </div>
      <div class="card">
        <div style="font-size:14px;font-weight:700;margin-bottom:16px">Payment history</div>
        <div style="font-size:13px;color:var(--text-3);padding:20px 0;text-align:center">Payment history available once backend is connected.</div>
        <div style="margin-top:12px;font-size:12px;color:var(--text-3)">
          <i data-lucide="shield" style="width:12px;height:12px;color:var(--success)"></i> Secured by Stripe · EU GDPR
        </div>
      </div>
    </div>`;
}

function _tierLabel(t) { return {tier1:'Tier 1 — Essential',tier2:'Tier 2 — Guided',tier3:'Tier 3 — Premium'}[t]||t; }
function _tierPrice(t) { return {tier1:'249 PLN',tier2:'599 PLN',tier3:'999 PLN'}[t]||'—'; }
function _tierFeaturesSummary(t) { return {
  tier1:'1 review cycle · Confirmation call (15 min) · 48h SLA',
  tier2:'5 review cycles · Direct messaging · Confirmation call (30 min) · 24h SLA',
  tier3:'Unlimited review cycles · Unlimited calls · Direct messaging · 12h SLA'
}[t]||'—'; }

// ─── CLIENT FAMILY ───
function renderClientFamily() {
  const u = AppState.user;
  const canUse = u && (u.tier==='tier2'||u.tier==='tier3');
  if (!canUse) return `
    <div class="dash-topbar"><div class="dash-page-title">Family Members</div></div>
    <div class="card" style="max-width:560px">
      <div style="background:var(--surface);border-radius:12px;padding:24px;text-align:center">
        <i data-lucide="lock" style="width:32px;height:32px;color:var(--text-4);margin:0 auto 12px;display:block"></i>
        <div style="font-size:14px;font-weight:700;margin-bottom:6px">Available on Tier 2 and Tier 3</div>
        <div style="font-size:13px;color:var(--text-3)">Upgrade your plan to add family members (+300 PLN per person).</div>
        <button class="btn btn-primary" style="margin-top:16px" onclick="clientNav('billing')">Upgrade plan</button>
      </div></div>`;
  return `
    <div class="dash-topbar">
      <div class="dash-page-title">Family Members</div>
      <button class="btn btn-primary btn-sm" onclick="showToast('Family add-on available once backend is connected.','info')">
        <i data-lucide="user-plus"></i> Add member (+300 PLN)
      </button>
    </div>
    <div class="card" style="max-width:560px">
      <div style="font-size:14px;color:var(--text-2);margin-bottom:20px;line-height:1.65">You can add a spouse or children to your application for <strong>+300 PLN per person</strong>. Their documents will be reviewed alongside yours.</div>
      <div style="background:var(--surface);border-radius:14px;padding:20px;text-align:center">
        <i data-lucide="users" style="width:40px;height:40px;color:var(--text-4);margin:0 auto 12px"></i>
        <div style="font-size:14px;font-weight:600;color:var(--text-3)">No family members added yet</div>
        <button class="btn btn-outline" style="margin-top:12px" onclick="showToast('Family add-on available once backend is connected.','info')">
          <i data-lucide="user-plus"></i> Add family member
        </button>
      </div>
    </div>`;
}

// ─── CLIENT REFERRAL ───
function renderClientReferral() {
  const u    = AppState.user;
  const code = u && u.referralCode ? u.referralCode : '—';
  return `
    <div class="dash-topbar"><div class="dash-page-title">Refer & Earn</div></div>
    <div class="card" style="max-width:520px">
      <div style="background:var(--dark);border-radius:16px;padding:24px;color:white;margin-bottom:20px">
        <div style="font-size:12px;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.45);margin-bottom:8px">Your referral code</div>
        <div style="font-family:monospace;font-size:28px;font-weight:700;letter-spacing:0.08em">${code}</div>
        <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:8px">Each friend who signs up gets 10% off. You get 150 PLN credit.</div>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:20px">
        <input type="text" class="form-input" value="kartaflow.pl/?ref=${code}" readonly style="flex:1;background:var(--surface)">
        <button class="btn btn-primary" onclick="showToast('Link copied to clipboard!','success')"><i data-lucide="copy"></i> Copy</button>
      </div>
    </div>`;
}

// ─── SPECIALIST DASHBOARD ───
function specialistNav(section, btn) {
  document.querySelectorAll('#page-lawyer .dash-nav-item').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const main = document.getElementById('lawyer-main');
  if (!main) return;
  const renders = {
    queue:renderSpecialistQueue, review:renderSpecialistReview,
    completed:renderSpecialistCompleted, calendar:renderSpecialistCalendar, metrics:renderSpecialistMetrics
  };
  main.innerHTML = (renders[section]||renders.queue)();
  lucide.createIcons();
}

// Preserve HTML onclick compatibility
function lawyerNav(section, btn) { specialistNav(section, btn); }
function renderSpecialistDashboard(s) { specialistNav(s||'queue'); }

function renderSpecialistQueue() {
  return `
    <div class="dash-topbar">
      <div class="dash-page-title">Client Queue</div>
      <span class="badge badge-grey"><i data-lucide="inbox" style="width:11px;height:11px"></i> Loading</span>
    </div>
    <div class="card" style="text-align:center;padding:48px 24px">
      <i data-lucide="inbox" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">Client queue will load once backend is connected.</div>
    </div>`;
}

function renderSpecialistReview() {
  return `
    <div class="dash-topbar"><div class="dash-page-title">Active Review</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card" style="text-align:center;padding:48px 24px">
        <i data-lucide="folder-open" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
        <div style="font-size:15px;font-weight:600;color:var(--text-3)">Select a case from the queue to begin review.</div>
      </div>
      <div class="card">
        <div style="font-size:14px;font-weight:700;margin-bottom:14px">Send feedback to client</div>
        <textarea class="form-input" rows="5" style="margin-bottom:12px;min-height:120px;resize:vertical" placeholder="Write your review feedback in English…" disabled></textarea>
        <div style="display:flex;gap:8px">
          <button class="btn btn-primary" disabled><i data-lucide="send"></i> Send feedback</button>
          <button class="btn btn-outline" disabled style="color:var(--success);border-color:rgba(22,163,74,0.3)"><i data-lucide="check-circle"></i> Approve all</button>
        </div>
      </div>
    </div>`;
}

function renderSpecialistCompleted() {
  return `
    <div class="dash-topbar"><div class="dash-page-title">Completed Cases</div></div>
    <div class="card" style="text-align:center;padding:48px 24px">
      <i data-lucide="check-circle" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">Completed cases will appear here once backend is connected.</div>
    </div>`;
}

function renderSpecialistCalendar() {
  return `
    <div class="dash-topbar"><div class="dash-page-title">Calendar</div></div>
    <div class="card" style="max-width:500px;text-align:center;padding:48px 24px">
      <i data-lucide="calendar" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">Calendar will load once backend is connected.</div>
    </div>`;
}

function renderSpecialistMetrics() {
  return `
    <div class="dash-topbar"><div class="dash-page-title">My Metrics</div></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px">
      ${['Cases this month','Avg review time','Success rate','SLA breaches','Pending queue','Avg feedback cycles'].map(l=>`
        <div class="stat-card"><div class="stat-label">${l}</div><div class="stat-value" style="color:var(--text-4)">—</div></div>
      `).join('')}
    </div>`;
}

// ─── SPECIALIST DASHBOARD ───
async function renderSpecialistPage() {
  const u = AppState.user;
  if (!u) return;

  // Hydrate sidebar
  const nameEl   = document.getElementById('specialist-name-sp');
  const avatarEl = document.getElementById('specialist-avatar-sp');
  const roleEl   = document.getElementById('specialist-role-sp');
  if (nameEl)   nameEl.textContent   = (u.firstName || '') + ' ' + (u.lastName || '');
  if (avatarEl) avatarEl.textContent = ((u.firstName||'S')[0] + (u.lastName||'P')[0]).toUpperCase();
  if (roleEl)   roleEl.textContent   = u.role === 'admin' ? 'Admin' : 'Specialist';

  // Set active nav
  specialistNav('cases', document.getElementById('sp-nav-cases'));

  // Fetch cases
  await _fetchSpecialistCases();
  _renderSpecialistCaseTable();
}

async function _fetchSpecialistCases() {
  try {
    const { data, error } = await _supabase
      .from('cases')
      .select('id, status, created_at, user_id')
      .order('created_at', { ascending: false });
    if (!error && data) {
      AppState.specialistCases = data;
    } else {
      AppState.specialistCases = [];
    }
  } catch (_) {
    AppState.specialistCases = [];
  }
}

function specialistNav(section, btn) {
  document.querySelectorAll('#page-specialist .dash-nav-item').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  if (section === 'cases') {
    _renderSpecialistCaseTable();
  }
}

function _renderSpecialistCaseTable() {
  const main = document.getElementById('specialist-main');
  if (!main) return;

  const cases = AppState.specialistCases || [];

  const rows = cases.length > 0
    ? cases.map(c => {
        const statusBadge = _specialistStatusBadge(c.status);
        const date = c.created_at ? new Date(c.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) : '—';
        return `<tr>
          <td style="font-family:var(--font-body);font-size:13px;color:var(--text-3)">${c.id ? c.id.substring(0,8).toUpperCase() : '—'}</td>
          <td>${statusBadge}</td>
          <td style="font-size:13px;color:var(--text-2)">${date}</td>
          <td>
            <button class="btn btn-surface btn-sm" onclick="specialistOpenCase('${c.id}')">
              Open
            </button>
          </td>
        </tr>`;
      }).join('')
    : `<tr><td colspan="4" style="text-align:center;padding:48px 24px;color:var(--text-3);font-size:14px">No cases found.</td></tr>`;

  main.innerHTML = `
    <div class="dash-topbar">
      <div>
        <div class="dash-page-title">Specialist Dashboard</div>
        <div class="dash-page-sub">Manage and review client cases</div>
      </div>
    </div>
    <div class="card" style="padding:0;overflow:hidden">
      <table class="data-table">
        <thead>
          <tr>
            <th>Case ID</th>
            <th>Status</th>
            <th>Created Date</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  lucide.createIcons();
}

function _specialistStatusBadge(status) {
  if (!status) return `<span class="badge badge-grey">—</span>`;
  const map = {
    questionnaire_pending:  ['badge-amber', 'Questionnaire Pending'],
    questionnaire_complete: ['badge-amber', 'Questionnaire Done'],
    call_pending:           ['badge-amber', 'Call Pending'],
    call_confirmed:         ['badge-green', 'Call Confirmed'],
    documents_pending:      ['badge-amber', 'Docs Pending'],
    ai_checking:            ['badge-amber', 'AI Checking'],
    needs_revision:         ['badge-red',   'Needs Revision'],
    in_review:              ['badge-dark',  'In Review'],
    approved:               ['badge-green', 'Approved'],
    submitted:              ['badge-green', 'Submitted'],
    completed:              ['badge-green', 'Completed'],
  };
  const [cls, label] = map[status] || ['badge-grey', status];
  return `<span class="badge ${cls}">${label}</span>`;
}

function specialistOpenCase(caseId) {
  const c = (AppState.specialistCases || []).find(x => x.id === caseId);
  AppState.selectedCase = c || { id: caseId };
  _renderSpecialistCaseDetail();
}

function _renderSpecialistCaseDetail() {
  const main = document.getElementById('specialist-main');
  if (!main) return;
  const c = AppState.selectedCase || {};
  const caseId = c.id;
  const status = c.status;

  function actionsCard() {
    let buttons = '';
    if (status === 'call_pending') {
      buttons = `
        <button id="sa-btn-confirm" class="btn btn-primary" onclick="_specialistCaseAction('call_confirmed', ['sa-btn-confirm'])">
          <i data-lucide="phone-call"></i> Confirm Call
        </button>`;
    } else if (status === 'in_review') {
      buttons = `
        <button id="sa-btn-revision" class="btn btn-outline" onclick="_specialistCaseAction('needs_revision', ['sa-btn-revision','sa-btn-approve'])">
          <i data-lucide="rotate-ccw"></i> Request Revision
        </button>
        <button id="sa-btn-approve" class="btn btn-primary" onclick="_specialistCaseAction('approved', ['sa-btn-revision','sa-btn-approve'])">
          <i data-lucide="check-circle"></i> Approve
        </button>`;
    } else if (status === 'approved') {
      buttons = `
        <button id="sa-btn-complete" class="btn btn-primary" onclick="_specialistCaseAction('completed', ['sa-btn-complete'])">
          <i data-lucide="flag"></i> Mark Completed
        </button>`;
    }

    if (!buttons) return '';

    return `
      <div class="card" style="margin-bottom:20px">
        <div style="font-size:14px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px">
          <i data-lucide="zap" style="width:16px;height:16px;color:var(--red)"></i> Case Actions
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">${buttons}</div>
      </div>`;
  }

  main.innerHTML = `
    <div class="dash-topbar">
      <div>
        <div class="dash-page-title" style="display:flex;align-items:center;gap:10px">
          Case Detail
          ${_specialistStatusBadge(status)}
        </div>
        <div class="dash-page-sub">Case ID: ${caseId ? caseId.substring(0,8).toUpperCase() : '—'}</div>
      </div>
      <button class="btn btn-outline btn-sm" onclick="_renderSpecialistCaseTable()">
        <i data-lucide="arrow-left"></i> Back to Cases
      </button>
    </div>
    ${actionsCard()}
    <div class="card" style="text-align:center;padding:64px 24px">
      <i data-lucide="file-text" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:16px;font-weight:700;margin-bottom:8px">Case Detail View (Phase 7B)</div>
      <div style="font-size:13px;color:var(--text-3)">Full case detail interface will be available in Phase 7B.</div>
    </div>`;
  lucide.createIcons();
}

async function _specialistCaseAction(newStatus, btnIds) {
  const c = AppState.selectedCase;
  if (!c || !c.id) return;

  const btns = btnIds.map(id => document.getElementById(id)).filter(Boolean);
  btns.forEach(b => { b.disabled = true; b.style.opacity = '0.6'; });

  try {
    const { error } = await supabase.rpc('update_case_status', {
      p_case_id: c.id,
      p_new_status: newStatus
    });

    if (error) throw error;

    // Re-fetch case and update AppState
    const { data: updated, error: fetchErr } = await supabase
      .from('cases')
      .select('*')
      .eq('id', c.id)
      .single();

    if (fetchErr) throw fetchErr;

    AppState.selectedCase = updated;

    // Also update in specialistCases list
    if (AppState.specialistCases) {
      const idx = AppState.specialistCases.findIndex(x => x.id === c.id);
      if (idx !== -1) AppState.specialistCases[idx] = updated;
    }

    _renderSpecialistCaseDetail();
  } catch (err) {
    // Silently sign out on error — same pattern used elsewhere
    await supabase.auth.signOut();
    AppState.user = null;
    AppState.profile = null;
    showPage('auth');
  }
}

// ─── ADMIN DASHBOARD ───
function adminNav(section, btn) {
  document.querySelectorAll('#page-admin .dash-nav-item').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const main = document.getElementById('admin-main');
  if (!main) return;
  const renders = {
    dashboard:renderAdminOverview, clients:renderAdminClients, lawyers:renderAdminSpecialists,
    revenue:renderAdminRevenue, promos:renderAdminPromos, refunds:renderAdminRefunds, audit:renderAdminAudit
  };
  main.innerHTML = (renders[section]||renders.dashboard)();
  lucide.createIcons();
}

function renderAdminDashboard(s) { adminNav(s||'dashboard'); }

function renderAdminOverview() {
  return `
    <div class="dash-topbar">
      <div class="dash-page-title">Admin Dashboard</div>
      <span style="font-size:13px;color:var(--text-3)">${new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}</span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px">
      ${['Active clients','Revenue (MTD)','Avg SLA breach','Pending reviews','Success rate','Open refund cases'].map(l=>`
        <div class="stat-card"><div class="stat-label">${l}</div><div class="stat-value" style="font-size:24px;color:var(--text-4)">—</div></div>
      `).join('')}
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
      <div class="card"><div style="font-size:14px;font-weight:700;margin-bottom:12px">Recent activity</div>
        <div style="font-size:13px;color:var(--text-3);padding:24px 0;text-align:center">Activity feed will load once backend is connected.</div></div>
      <div class="card"><div style="font-size:14px;font-weight:700;margin-bottom:12px">Tier distribution</div>
        <div style="font-size:13px;color:var(--text-3);padding:24px 0;text-align:center">Distribution data will load once backend is connected.</div></div>
    </div>`;
}

function renderAdminClients() {
  return `
    <div class="dash-topbar">
      <div class="dash-page-title">All Clients</div>
      <input type="text" class="form-input" placeholder="Search clients…" style="max-width:220px">
    </div>
    <div class="card" style="text-align:center;padding:48px 24px">
      <i data-lucide="users" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">Client list will load once backend is connected.</div>
    </div>`;
}

function renderAdminSpecialists() {
  return `
    <div class="dash-topbar"><div class="dash-page-title">Specialists</div></div>
    <div class="card" style="max-width:600px;text-align:center;padding:48px 24px">
      <i data-lucide="scale" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">Specialist profiles will load once backend is connected.</div>
    </div>`;
}

function renderAdminRevenue() {
  return `
    <div class="dash-topbar"><div class="dash-page-title">Revenue</div></div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px">
      ${['MTD revenue','Avg order value','Total clients'].map(l=>`<div class="stat-card"><div class="stat-label">${l}</div><div class="stat-value" style="font-size:22px;color:var(--text-4)">—</div></div>`).join('')}
    </div>
    <div class="card" style="text-align:center;padding:48px 24px">
      <div style="font-size:13px;color:var(--text-3)">Revenue data will load once backend is connected.</div>
    </div>`;
}

function renderAdminPromos() {
  return `
    <div class="dash-topbar">
      <div class="dash-page-title">Promo Codes</div>
      <button class="btn btn-primary btn-sm" onclick="showToast('Promo management available once backend is connected.','info')"><i data-lucide="plus"></i> Create promo</button>
    </div>
    <div class="card" style="text-align:center;padding:48px 24px">
      <i data-lucide="tag" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">Promo codes will load once backend is connected.</div>
    </div>`;
}

function renderAdminRefunds() {
  return `
    <div class="dash-topbar"><div class="dash-page-title">Refund Management</div></div>
    <div class="card" style="text-align:center;padding:48px 24px">
      <i data-lucide="rotate-ccw" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">Refund requests will load once backend is connected.</div>
    </div>`;
}

function renderAdminAudit() {
  return `
    <div class="dash-topbar">
      <div class="dash-page-title">Audit Log</div>
      <button class="btn btn-outline btn-sm" onclick="showToast('Export available once backend is connected.','info')"><i data-lucide="download"></i> Export</button>
    </div>
    <div class="card" style="text-align:center;padding:48px 24px">
      <i data-lucide="shield" style="width:48px;height:48px;color:var(--text-4);margin:0 auto 16px;display:block"></i>
      <div style="font-size:15px;font-weight:600;color:var(--text-3)">Audit logs will load once backend is connected.</div>
    </div>`;
}

// ─── DOCUMENT UPLOAD ───

async function refreshDocuments() {
  if (!AppState.case || !AppState.case.id) return;
  try {
    const { data, error } = await _supabase
      .from('documents')
      .select('*')
      .eq('case_id', AppState.case.id)
      .is('deleted_at', null);
    if (error) {
      await _supabase.auth.signOut();
      return;
    }
    AppState.documents = (data || []).map(d => ({
      id:           d.id,
      documentType: d.document_type,
      fileName:     d.original_filename,
      storagePath:  d.storage_path,
      mimeType:     d.mime_type,
      sizeBytes:    d.size_bytes,
      status:       d.status || 'pending',
      createdAt:    d.created_at,
    }));
  } catch (_) {}
}

async function refreshCase() {
  if (!AppState.user) return;
  AppState.case = await _fetchCase(AppState.user);
}

function openUploadModal() {
  if (!AppState.case || !AppState.case.id) {
    showToast('No active case found. Please refresh.', 'error');
    return;
  }
  let modal = document.getElementById('upload-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'upload-modal';
    modal.style.cssText = 'position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;padding:20px';
    modal.innerHTML = `
      <div style="background:var(--white);border-radius:var(--r-lg);padding:32px;max-width:440px;width:100%;box-shadow:var(--shadow-lg)">
        <div style="font-size:17px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between">
          <span>Upload Document</span>
          <button onclick="closeUploadModal()" style="background:none;border:none;cursor:pointer;color:var(--text-3);padding:4px"><i data-lucide="x" style="width:18px;height:18px"></i></button>
        </div>
        <div class="form-group" style="margin-bottom:16px">
          <label class="form-label">Document type</label>
          <select class="form-select" id="upload-doc-type">
            <option value="">— Select document type —</option>
            <option value="passport">Passport</option>
            <option value="work_permit">Work Permit (Zezwolenie na pracę)</option>
            <option value="employment_contract">Employment Contract</option>
            <option value="residence_registration">Residence Registration (Zameldowanie)</option>
            <option value="tax_id">Tax ID (NIP/PESEL)</option>
            <option value="health_insurance">Health Insurance</option>
            <option value="bank_statement">Bank Statement</option>
            <option value="housing_agreement">Housing Agreement / Lease</option>
            <option value="university_enrollment">University Enrollment Confirmation</option>
            <option value="marriage_certificate">Marriage Certificate</option>
            <option value="birth_certificate">Birth Certificate</option>
            <option value="photos">Biometric Photos</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom:24px">
          <label class="form-label">File</label>
          <input type="file" id="upload-file-input" class="form-input" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="padding:10px">
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-primary btn-full" id="upload-confirm-btn" onclick="handleDocumentUpload()">
            <i data-lucide="upload-cloud"></i> Upload
          </button>
          <button class="btn btn-outline" onclick="closeUploadModal()">Cancel</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  } else {
    modal.style.display = 'flex';
  }
  document.getElementById('upload-doc-type').value = '';
  const fi = document.getElementById('upload-file-input');
  if (fi) fi.value = '';
  const btn = document.getElementById('upload-confirm-btn');
  if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="upload-cloud" style="width:16px;height:16px"></i> Upload'; }
  lucide.createIcons();
}

function closeUploadModal() {
  const modal = document.getElementById('upload-modal');
  if (modal) modal.style.display = 'none';
}

let isUploading = false;

async function handleDocumentUpload() {
  if (isUploading) return;

  if (!AppState.case || !AppState.case.id) {
    await _supabase.auth.signOut();
    return;
  }

  const docTypeEl = document.getElementById('upload-doc-type');
  const fileEl    = document.getElementById('upload-file-input');
  const btn       = document.getElementById('upload-confirm-btn');

  const selectedType = docTypeEl ? docTypeEl.value : '';
  const file         = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;

  if (!selectedType) { showToast('Please select a document type.', 'error'); return; }
  if (!file)         { showToast('Please select a file to upload.', 'error'); return; }

  isUploading = true;
  if (fileEl) { fileEl.disabled = true; fileEl.style.opacity = '0.6'; }
  if (btn) { btn.disabled = true; btn.innerHTML = '<i data-lucide="loader-2" style="width:16px;height:16px"></i> Uploading…'; lucide.createIcons(); }

  try {
    const ext         = file.name.split('.').pop();
    const uuid        = crypto.randomUUID();
    const caseId      = AppState.case.id;
    const storagePath = `${caseId}/${selectedType}/${uuid}.${ext}`;

    const { error: uploadError } = await _supabase.storage
      .from('kf-documents')
      .upload(storagePath, file);

    if (uploadError) {
      await _supabase.auth.signOut();
      return;
    }

    const { error: insertError } = await _supabase
      .from('documents')
      .insert({
        case_id:           caseId,
        document_type:     selectedType,
        storage_path:      storagePath,
        original_filename: file.name,
        mime_type:         file.type,
        size_bytes:        file.size,
      });

    if (insertError) {
      await _supabase.auth.signOut();
      return;
    }

    await refreshDocuments();
    closeUploadModal();
    renderClientSection('documents');
    showToast('Document uploaded successfully.', 'success');

  } catch (_) {
    await _supabase.auth.signOut();
  } finally {
    isUploading = false;
    if (fileEl) { fileEl.disabled = false; fileEl.style.opacity = ''; }
    if (btn) { btn.disabled = false; btn.innerHTML = '<i data-lucide="upload-cloud" style="width:16px;height:16px"></i> Upload'; lucide.createIcons(); }
  }
}

// ─── FAQ ───
const faqs = [
  {q:"Is this real legal advice? Or just a website?",a:"KartaFlow combines technology tools with genuine legal review. The immigration specialist is a licensed Polish immigration lawyer (Radca Prawny) who personally reads your documents and provides written legal feedback. You also sign a formal lawyer engagement letter — this creates a real, protected legal relationship under Polish law."},
  {q:"What exactly is a TRC (Karta Pobytu)?",a:"A TRC (Temporary Residence Card / Karta Pobytu) is Poland's residence permit for foreigners. It allows you to legally live and work in Poland without needing a separate work visa. Most foreigners apply for a Work TRC (through their employer), a Family TRC, or a Student TRC."},
  {q:"What do I actually get in each tier?",a:"Tier 1 (249 PLN): Smart checklist, AI document check, 1 specialist review cycle, 15-min confirmation call. Tier 2 (599 PLN): 5 review cycles, direct messaging, 30-min confirmation call, 24h SLA. Tier 3 (999 PLN): Unlimited review cycles, unlimited calls, express 12h SLA, rejection appeal guidance."},
  {q:"What if I upload the wrong documents?",a:"Our AI document check runs before the specialist ever sees your files. It will flag documents that are unclear, expired, or missing. You can then fix and re-upload before specialist review begins."},
  {q:"Can I get a refund?",a:"Full refund within 24 hours of payment if no specialist review has started. 50% refund after review has started but before any feedback is delivered. No refund after first feedback is delivered."},
  {q:"How is my data protected?",a:"All documents are encrypted with AES-256 at rest and TLS 1.3 in transit. Data is stored exclusively on EU-based servers. The specialist reviews documents inside a secure browser viewer — files are never downloaded."},
  {q:"I don't speak Polish. Can you still help me?",a:"Yes — KartaFlow is built for foreigners. All checklists, instructions, and specialist feedback are provided in English."},
  {q:"What happens if my application is rejected after using KartaFlow?",a:"In the event of rejection, Tier 3 clients receive rejection review and appeal guidance from the specialist directly. For Tier 1 and 2 clients, we will review the rejection notice with you and advise on next steps."},
];

function renderFAQ() {
  const el = document.getElementById('faq-list');
  if (!el) return;
  el.innerHTML = faqs.map((f,i) => `
    <div class="faq-item reveal" onclick="toggleFAQ(this)">
      <div class="faq-q"><span>${f.q}</span><div class="faq-q-icon"><i data-lucide="plus" style="width:14px;height:14px"></i></div></div>
      <div class="faq-a">${f.a}</div>
    </div>`).join('');
  lucide.createIcons();
  document.querySelectorAll('.faq-item.reveal').forEach(el => revealObserver.observe(el));
}

function toggleFAQ(el) { el.classList.toggle('open'); lucide.createIcons(); }

// ─── TOAST ───
function showToast(msg, type='success') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast ' + type;
  const icon = type==='success'?'check-circle':type==='error'?'x-circle':'info';
  t.innerHTML = `<i data-lucide="${icon}" style="width:16px;height:16px;flex-shrink:0"></i><span>${msg}</span>`;
  c.appendChild(t); lucide.createIcons();
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(8px)';t.style.transition='all 0.3s';setTimeout(()=>t.remove(),300);},3200);
}

// ─── INIT ───
window.addEventListener("load", () => {
  renderFAQ();
  lucide.createIcons();
  initializeApp(); // Session check — triggers renderApp()
});

window.addEventListener('load', () => {
  document.querySelectorAll('.reveal').forEach(el => revealObserver.observe(el));
});

window.addEventListener("error", (e) => {
  console.error("Global error caught:", e.error);
  safeActivatePage("page-landing");
});

</script>
</html>
